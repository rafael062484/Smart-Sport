<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMARTSPORT AI Platform | Enterprise Sports Analytics</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700;800&family=JetBrains+Mono:wght@400;700&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="global-styles.css">
    <link rel="stylesheet" href="ai_popup_styles.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        /* 
           CSS VARIABLES – משתני עיצוב גלובליים
            */
        :root {
            --bg-body: #0a0e1a;
            --bg-panel: #111827;
            --bg-glass: rgba(26, 35, 50, 0.85);
            --primary: #60a5fa;
            --secondary: #93c5fd;
            --accent: #22d3ee;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --gold: #fbbf24;
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --text-dim: #64748b;
            --border: 1px solid rgba(255,255,255,0.08);
            --radius-sm: 8px;
            --radius-md: 14px;
            --radius-lg: 20px;
            --font-ui: 'Assistant', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --font-display: 'Orbitron', sans-serif;
            --shadow-lg: 0 25px 60px rgba(0,0,0,0.5);
            --transition: 0.3s ease;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            min-height: 100vh;
            background: var(--bg-body);
            color: var(--text);
            font-family: var(--font-ui);
            display: flex;
            line-height: 1.6;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        ::-webkit-scrollbar-thumb { background: linear-gradient(var(--primary), var(--secondary)); border-radius: 10px; }

        .bg-gradient {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(ellipse at 20% 20%, rgba(59,130,246,0.15), transparent 50%),
            radial-gradient(ellipse at 80% 80%, rgba(139,92,246,0.12), transparent 50%);
            pointer-events: none; z-index: 0;
        }

        /* 
           TOAST NOTIFICATIONS – הודעות מערכת
            */
        .toast-container { position: fixed; top: 100px; left: 50%; transform: translateX(-50%); z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: var(--bg-glass); backdrop-filter: blur(20px); border-radius: var(--radius-md); padding: 16px 24px; display: flex; align-items: center; gap: 12px; box-shadow: var(--shadow-lg); animation: toastIn 0.3s ease; min-width: 300px; }
        .toast.success { border: 1px solid var(--success); }
        .toast.error { border: 1px solid var(--danger); }
        .toast.warning { border: 1px solid var(--warning); }
        .toast.info { border: 1px solid var(--primary); }
        .toast-icon { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .toast.success .toast-icon { background: rgba(16,185,129,0.2); color: var(--success); }
        .toast.error .toast-icon { background: rgba(239,68,68,0.2); color: var(--danger); }
        .toast-content { flex: 1; }
        .toast-title { font-weight: 700; font-size: 14px; }
        .toast-message { font-size: 12px; color: var(--text-muted); }
        .toast-close { background: none; border: none; color: var(--text-muted); cursor: pointer; }
        @keyframes toastIn { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /*
           SIDEBAR – תפריט צד
            */
        .sidebar {
            width: 220px;
            height: 100vh;
            position: fixed;
            right: 0;
            top: 0;
            background: rgba(5, 8, 16, 0.98);
            backdrop-filter: blur(40px);
            border-left: 1px solid var(--border);
            z-index: 1000;
            padding: 28px 24px;
            overflow-y: auto;
            box-shadow: -10px 0 30px rgba(0,0,0,0.3);
        }

        .logo-area {
            margin-bottom: 36px;
            padding-bottom: 24px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            text-align: center;
        }

        .logo-icon {
            font-size: 42px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 12px;
        }

        .logo-text {
            font-size: 22px;
            font-weight: 800;
            letter-spacing: -0.5px;
            background: linear-gradient(135deg, #fff, #60a5fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-group { margin-bottom: 28px; }

        .nav-title {
            font-size: 11px;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 1.5px;
            margin-bottom: 12px;
            color: var(--text-dim);
            padding-left: 12px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: var(--text-muted);
            text-decoration: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            margin-bottom: 4px;
        }

        .nav-item i {
            width: 20px;
            text-align: center;
            font-size: 16px;
        }

        .nav-item:hover {
            background: rgba(59, 130, 246, 0.08);
            color: #60a5fa;
            transform: translateX(-2px);
        }

        .nav-item.active {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.15), transparent);
            color: var(--primary);
            border-left: 3px solid var(--primary);
        }

        /*
           MAIN AREA – אזור ראשי
            */
        .main-area { margin-right: 220px; flex: 1; display: flex; flex-direction: column; position: relative; overflow: auto; z-index: 1; }
        .top-bar { height: 80px; border-bottom: var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 35px; background: rgba(2,6,23,0.8); backdrop-filter: blur(20px); }
        .page-title h1 { font-size: 22px; font-weight: 800; display: flex; align-items: center; gap: 10px; font-family: var(--font-display); }
        .page-title h1 i { background: linear-gradient(135deg, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .page-title span { font-size: 11px; color: var(--text-muted); font-family: var(--font-mono); display: block; margin-top: 4px; }
        .version-badge { background: linear-gradient(135deg, rgba(251,191,36,0.2), rgba(245,158,11,0.1)); border: 1px solid rgba(251,191,36,0.3); color: var(--gold); font-size: 10px; font-weight: 800; padding: 3px 8px; border-radius: 15px; margin-left: 10px; }
        .status-area { display: flex; gap: 10px; }
        .status-badge { background: rgba(16,185,129,0.1); color: var(--success); padding: 8px 16px; border-radius: 25px; font-size: 11px; font-weight: 700; font-family: var(--font-mono); border: 1px solid rgba(16,185,129,0.25); display: flex; align-items: center; gap: 8px; }
        .pulsing-dot { width: 8px; height: 8px; background: var(--success); border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .ai-badge { background: linear-gradient(135deg, rgba(139,92,246,0.2), rgba(59,130,246,0.15)); border: 1px solid rgba(139,92,246,0.4); color: #a78bfa; padding: 8px 16px; border-radius: 25px; font-size: 11px; font-weight: 700; font-family: var(--font-mono); display: flex; align-items: center; gap: 6px; }
        .ai-badge i { animation: spin 3s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* 
           CONTENT GRID – רשת תוכן
            */
        .content { flex: 1; padding: 30px; display: grid; grid-template-columns: 380px 1fr; gap: 25px; overflow-y: auto; }
        .glass-panel { background: linear-gradient(145deg, rgba(30,41,59,0.7), rgba(15,23,42,0.85)); backdrop-filter: blur(30px); border: 1px solid rgba(255,255,255,0.08); border-radius: var(--radius-lg); padding: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); }
        .control-panel { height: fit-content; position: sticky; top: 0; }
        .cp-header { font-weight: 800; font-size: 17px; margin-bottom: 6px; display: flex; align-items: center; gap: 10px; }
        .cp-header i { color: var(--accent); }
        .cp-subtitle { font-size: 12px; color: var(--text-muted); margin-bottom: 22px; padding-bottom: 18px; border-bottom: var(--border); line-height: 1.7; }

        /* 
           MODE SELECTOR – בחירת מצב (ליגה / מותאם / batch / טוטו16)
            */
        .mode-selector { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 22px; }
        .mode-card { background: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.1); border-radius: var(--radius-md); padding: 16px 12px; cursor: pointer; transition: var(--transition); text-align: center; }
        .mode-card:hover { border-color: var(--primary); transform: translateY(-2px); }
        .mode-card.active { border-color: var(--primary); background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(139,92,246,0.1)); box-shadow: 0 0 20px rgba(59,130,246,0.3); }
        /* טוטו 16 – הבלטה מיוחדת */
        .mode-card.toto-highlight { border-color: var(--gold); background: linear-gradient(135deg, rgba(251,191,36,0.2), rgba(245,158,11,0.1)); }
        .mode-card.toto-highlight:hover { box-shadow: 0 0 25px rgba(251,191,36,0.4); }
        .mode-card.toto-highlight.active { border-color: var(--gold); box-shadow: 0 0 30px rgba(251,191,36,0.5); }
        .mode-icon { font-size: 26px; margin-bottom: 8px; }
        .mode-title { font-size: 13px; font-weight: 700; margin-bottom: 3px; }
        .mode-desc { font-size: 10px; color: var(--text-muted); }

        /* 
           AI BANNER – באנר סטטוס AI
            */
        .ai-banner { background: linear-gradient(135deg, rgba(139,92,246,0.15), rgba(59,130,246,0.1)); border: 1px solid rgba(139,92,246,0.3); border-radius: var(--radius-md); padding: 14px 18px; margin-bottom: 18px; display: flex; align-items: center; gap: 14px; }
        .ai-banner-icon { width: 44px; height: 44px; background: linear-gradient(135deg, var(--secondary), var(--primary)); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 22px; color: white; }
        .ai-banner-content { flex: 1; }
        .ai-banner-title { font-size: 13px; font-weight: 800; display: flex; align-items: center; gap: 6px; }
        .ai-banner-desc { font-size: 11px; color: var(--text-muted); }
        .ai-banner-status { font-size: 10px; font-weight: 700; font-family: var(--font-mono); color: var(--success); display: flex; align-items: center; gap: 6px; }
        .ai-banner-status .dot { width: 6px; height: 6px; background: var(--success); border-radius: 50%; animation: pulse 1.5s infinite; }

        /* 
           MODE CONTENT – תוכן לפי מצב
            */
        .mode-content { display: none; animation: fadeIn 0.3s ease; }
        .mode-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        /* 
           FORM ELEMENTS – אלמנטי טופס
            */
        .form-group { margin-bottom: 16px; }
        label { font-size: 11px; color: var(--text-muted); font-weight: 600; margin-bottom: 6px; display: flex; align-items: center; gap: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        label i { color: var(--primary); font-size: 11px; }
        .help-tooltip { cursor: help; color: var(--primary); opacity: 0.7; transition: all 0.3s ease; }
        .help-tooltip:hover { opacity: 1; transform: scale(1.1); }
        .help-tooltip i { font-size: 12px; }
        select { width: 100%; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); color: var(--text); padding: 12px 14px; border-radius: var(--radius-md); outline: none; transition: var(--transition); font-size: 13px; font-family: var(--font-ui); font-weight: 600; cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2394a3b8' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: left 14px center; }
        select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59,130,246,0.2); }
        select option { background: var(--bg-panel); color: var(--text); padding: 10px; }
        input[type="date"] { width: 100%; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); color: var(--text); padding: 12px 14px; border-radius: var(--radius-md); font-size: 13px; font-family: var(--font-ui); font-weight: 600; }
        input[type="date"]:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,0.2); }

        /* 
           BUTTONS – כפתורים
            */
        .btn-main { width: 100%; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; padding: 14px; border-radius: var(--radius-md); font-weight: 800; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: var(--transition); box-shadow: 0 8px 25px rgba(59,130,246,0.4); text-transform: uppercase; letter-spacing: 1px; margin-top: 8px; }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 12px 35px rgba(59,130,246,0.5); }
        .btn-main:disabled { background: #334155; color: #64748b; cursor: not-allowed; transform: none; box-shadow: none; }
        /* כפתור זהב מיוחד לטוטו */
        .btn-gold { background: linear-gradient(135deg, var(--gold), var(--warning)); box-shadow: 0 8px 25px rgba(251,191,36,0.4); }
        .btn-gold:hover { box-shadow: 0 12px 35px rgba(251,191,36,0.5); }
        .btn-secondary { background: rgba(255,255,255,0.05); color: var(--text); border: 1px solid rgba(255,255,255,0.1); padding: 10px; border-radius: var(--radius-sm); cursor: pointer; font-size: 11px; font-weight: 700; flex: 1; transition: var(--transition); display: flex; justify-content: center; align-items: center; gap: 5px; }
        .btn-secondary:hover { background: rgba(255,255,255,0.1); }
        .btn-group { display: flex; gap: 8px; margin-top: 10px; }

        /* 
           BATCH MODE – מצב 4 משחקים
            */
        .batch-matches { display: flex; flex-direction: column; gap: 14px; }
        .batch-match { background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.08); border-radius: var(--radius-md); padding: 14px; }
        .batch-match-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .batch-match-title { font-size: 12px; font-weight: 600; color: var(--primary); }
        .batch-match-remove { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 12px; }
        .batch-match-remove:hover { color: var(--danger); }
        .batch-match-teams { display: grid; grid-template-columns: 1fr auto 1fr; gap: 8px; align-items: center; }
        .batch-match-teams select { font-size: 12px; padding: 10px 12px; }
        .batch-vs { font-size: 11px; color: var(--text-dim); font-weight: 700; }
        .add-match-btn { width: 100%; padding: 10px; background: rgba(59,130,246,0.1); border: 2px dashed rgba(59,130,246,0.3); border-radius: var(--radius-md); color: var(--primary); font-size: 12px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; margin-top: 10px; transition: var(--transition); }
        .add-match-btn:hover { background: rgba(59,130,246,0.2); border-color: var(--primary); }
        .add-match-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* 
           TOTO 16 MODE – מצב טוטו 16 חכם
            */
        .toto-container { max-height: 500px; overflow-y: auto; }
        .toto-game-row { display: flex; align-items: center; gap: 10px; padding: 12px; background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.08); border-radius: var(--radius-md); margin-bottom: 8px; }
        .toto-game-num { width: 28px; height: 28px; background: linear-gradient(135deg, var(--gold), var(--warning)); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 12px; color: #000; flex-shrink: 0; }
        .toto-teams { flex: 1; font-size: 12px; font-weight: 600; line-height: 1.4; }
        .toto-teams .home { color: var(--text); }
        .toto-teams .away { color: var(--text-muted); }
        .toto-picks { display: flex; gap: 6px; }
        .toto-pick-btn { width: 36px; height: 36px; border-radius: 8px; border: 2px solid rgba(255,255,255,0.15); background: rgba(0,0,0,0.3); color: var(--text-muted); font-weight: 800; font-size: 14px; cursor: pointer; transition: var(--transition); }
        .toto-pick-btn:hover { border-color: var(--primary); color: var(--text); }
        .toto-pick-btn.selected { background: linear-gradient(135deg, var(--primary), var(--secondary)); border-color: var(--primary); color: white; box-shadow: 0 4px 15px rgba(59,130,246,0.4); }
        .toto-pick-btn.ai-pick { position: relative; }
        .toto-pick-btn.ai-pick::after { content: ''; position: absolute; top: -8px; right: -8px; font-size: 10px; }
        .toto-summary { background: linear-gradient(135deg, rgba(251,191,36,0.15), rgba(245,158,11,0.1)); border: 1px solid rgba(251,191,36,0.3); border-radius: var(--radius-md); padding: 14px; margin-top: 12px; }
        .toto-summary-text { font-size: 12px; color: var(--text-muted); margin-bottom: 8px; }
        .toto-summary-stats { display: flex; gap: 20px; font-size: 13px; font-weight: 700; }
        .toto-summary-stats span { color: var(--gold); }

        /* 
           TERMINAL – טרמינל לוגים
            */
        .terminal { background: #050508; border-radius: var(--radius-md); border: 1px solid rgba(59,130,246,0.2); margin-top: 18px; overflow: hidden; }
        .terminal-header { background: rgba(59,130,246,0.08); padding: 8px 12px; display: flex; align-items: center; gap: 6px; border-bottom: 1px solid rgba(59,130,246,0.15); }
        .terminal-dot { width: 8px; height: 8px; border-radius: 50%; }
        .terminal-dot.red { background: #ff5f56; }
        .terminal-dot.yellow { background: #ffbd2e; }
        .terminal-dot.green { background: #27c93f; }
        .terminal-title { font-size: 9px; color: var(--text-dim); font-family: var(--font-mono); margin-right: auto; }
        .terminal-body { padding: 12px; font-family: var(--font-mono); font-size: 10px; line-height: 1.8; color: var(--success); max-height: 180px; overflow-y: auto; }
        .terminal-line { display: flex; align-items: flex-start; gap: 6px; margin-bottom: 3px; }
        .terminal-prompt { color: var(--accent); font-weight: 700; }
        .terminal-success { color: var(--success); }
        .terminal-warning { color: var(--warning); }
        .terminal-error { color: var(--danger); }
        .terminal-ai { color: #a78bfa; font-weight: 700; }
        .terminal-text { color: var(--text-muted); }

        /* 
           PREDICTIONS VIEW – תצוגת תחזיות
            */
        .predictions-view { display: flex; flex-direction: column; gap: 20px; }
        .view-header { display: flex; justify-content: space-between; align-items: center; }
        .view-title { font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .view-title i { color: var(--gold); }
        .view-controls { display: flex; gap: 6px; }
        .view-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: var(--text-muted); width: 32px; height: 32px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: var(--transition); }
        .view-btn:hover, .view-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .results-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 18px; }
        .results-grid.list-view { grid-template-columns: 1fr; }

        /* 
           RESULT CARD – כרטיס תחזית
            */
        .result-card { background: linear-gradient(145deg, rgba(30,41,59,0.6), rgba(15,23,42,0.8)); border: 1px solid rgba(255,255,255,0.06); border-radius: var(--radius-lg); padding: 22px; transition: var(--transition); position: relative; overflow: hidden; animation: cardIn 0.4s ease forwards; opacity: 0; }
        @keyframes cardIn { to { opacity: 1; } }
        .result-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 3px; background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent)); opacity: 0; transition: opacity 0.3s; }
        .result-card:hover { transform: translateY(-5px); border-color: rgba(255,255,255,0.1); box-shadow: 0 15px 40px rgba(0,0,0,0.4); }
        .result-card:hover::before { opacity: 1; }
        /* כפתור X למחיקת כרטיס */
        .card-close-btn { position: absolute; top: 12px; left: 12px; width: 28px; height: 28px; border-radius: 50%; background: rgba(239,68,68,0.2); border: 1px solid rgba(239,68,68,0.3); color: var(--danger); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; transition: var(--transition); z-index: 10; }
        .card-close-btn:hover { background: var(--danger); color: white; }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 14px; }
        .match-info { flex: 1; }
        .league-tag { font-size: 9px; color: var(--accent); font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 6px; display: flex; align-items: center; gap: 5px; }
        .teams-display { font-size: 16px; font-weight: 700; line-height: 1.4; }
        .team-winner { color: var(--gold); text-shadow: 0 0 10px rgba(251,191,36,0.3); }
        .vs-text { color: var(--text-muted); font-size: 12px; margin: 0 5px; }
        .confidence-ring { width: 60px; height: 60px; position: relative; }
        .confidence-ring svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .confidence-ring circle { fill: none; stroke-width: 5; }
        .confidence-ring .bg { stroke: rgba(255,255,255,0.1); }
        .confidence-ring .progress { stroke-linecap: round; transition: stroke-dashoffset 1.2s ease; }
        .confidence-value { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 13px; font-weight: 800; font-family: var(--font-mono); }
        .prediction-body { margin-bottom: 14px; }
        .prediction-label { font-size: 9px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 5px; }
        .prediction-value { font-size: 38px; font-weight: 900; background: linear-gradient(135deg, var(--gold), var(--warning)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-family: var(--font-display); letter-spacing: 3px; }

        .winner-banner { background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(59,130,246,0.1)); border: 1px solid rgba(16,185,129,0.3); border-radius: var(--radius-md); padding: 12px 16px; margin: 12px 0; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .winner-banner.winner-home { border-color: rgba(16,185,129,0.5); }
        .winner-banner.winner-away { border-color: rgba(239,68,68,0.5); background: linear-gradient(135deg, rgba(239,68,68,0.15), rgba(59,130,246,0.1)); }
        .winner-banner.winner-draw { border-color: rgba(148,163,184,0.5); background: linear-gradient(135deg, rgba(148,163,184,0.15), rgba(59,130,246,0.1)); }
        .winner-icon { font-size: 22px; }
        .winner-text { font-size: 14px; font-weight: 700; flex: 1; }
        .winner-text strong { color: var(--gold); }
        .conf-badge { font-size: 10px; padding: 4px 10px; border-radius: 20px; font-weight: 700; }

        .ai-insight { background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(59,130,246,0.05)); border: 1px solid rgba(139,92,246,0.2); border-radius: var(--radius-md); padding: 14px; margin-top: 10px; font-size: 12px; line-height: 1.7; color: var(--text); }
        .ai-insight-header { display: flex; align-items: center; gap: 6px; color: #a78bfa; font-weight: 700; font-size: 10px; text-transform: uppercase; margin-bottom: 8px; }
        .insight-badge { font-size: 9px; font-weight: 700; margin-right: auto; }
        .insight-text { line-height: 1.8; }
        .insight-read-more { color: var(--primary); cursor: pointer; font-weight: 600; margin-top: 8px; display: inline-block; font-size: 11px; }
        .insight-read-more:hover { color: var(--secondary); }

        /* סקשן ניתוח מפורט - DETAILED ANALYSIS */
        .detailed-analysis-section {
            background: linear-gradient(135deg, rgba(16,185,129,0.08), rgba(59,130,246,0.05));
            border: 1px solid rgba(16,185,129,0.2);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-top: 12px;
            position: relative;
            overflow: hidden;
            animation: sectionFadeIn 0.6s ease;
        }
        @keyframes sectionFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .detailed-analysis-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(16,185,129,0.1), transparent);
            animation: shimmer 3s infinite;
        }
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        .detailed-analysis-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
        .detailed-analysis-icon { font-size: 18px; animation: iconPulse 2s ease-in-out infinite; }
        @keyframes iconPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .detailed-analysis-title { font-size: 13px; font-weight: 800; color: var(--success); text-transform: uppercase; letter-spacing: 0.5px; }
        .confidence-reasoning { background: rgba(0,0,0,0.2); border-radius: var(--radius-sm); padding: 10px; margin-bottom: 10px; font-size: 11px; line-height: 1.7; border-right: 3px solid var(--success); }
        .key-factors-list { list-style: none; margin-top: 10px; }
        .key-factors-list li { background: rgba(0,0,0,0.15); padding: 10px 12px; margin-bottom: 6px; border-radius: var(--radius-sm); font-size: 11px; line-height: 1.6; border-right: 2px solid var(--accent); position: relative; padding-right: 30px; }
        .key-factors-list li::before { content: ''; position: absolute; left: 8px; font-size: 14px; }
        .alternative-scenarios { background: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.3); border-radius: var(--radius-sm); padding: 10px; margin-top: 10px; font-size: 11px; line-height: 1.6; color: var(--text); }
        .alternative-scenarios-title { font-weight: 700; color: var(--gold); margin-bottom: 6px; font-size: 10px; text-transform: uppercase; }

        /* סקשן שקיפות אלגוריתמית - ALGORITHMIC TRANSPARENCY */
        .algo-transparency-section {
            background: linear-gradient(135deg, rgba(251,191,36,0.08), rgba(245,158,11,0.05));
            border: 1px solid rgba(251,191,36,0.25);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-top: 12px;
            position: relative;
            overflow: hidden;
            animation: sectionFadeIn 0.8s ease;
        }
        .algo-transparency-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(251,191,36,0.15), transparent);
            animation: shimmer 3.5s infinite;
        }
        .algo-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; position: relative; z-index: 1; }
        .algo-icon { font-size: 18px; animation: iconRotate 4s linear infinite; }
        @keyframes iconRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .algo-title { font-size: 13px; font-weight: 800; color: var(--gold); text-transform: uppercase; letter-spacing: 0.5px; }
        .model-weights { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; margin-bottom: 12px; position: relative; z-index: 1; }
        .weight-item {
            background: rgba(0,0,0,0.2);
            border-radius: var(--radius-sm);
            padding: 8px;
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }
        .weight-item:hover {
            background: rgba(251,191,36,0.15);
            border-color: rgba(251,191,36,0.4);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(251,191,36,0.2);
        }
        .weight-label { font-size: 9px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; }
        .weight-value { font-size: 15px; font-weight: 800; color: var(--gold); font-family: var(--font-mono); }
        .weight-bar { height: 3px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 4px; position: relative; overflow: hidden; }
        .weight-bar::after {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: var(--weight);
            background: linear-gradient(90deg, var(--gold), var(--warning));
            border-radius: 2px;
            animation: barFill 1s ease;
        }
        @keyframes barFill {
            from { width: 0; }
            to { width: var(--weight); }
        }
        .data-quality-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(16,185,129,0.2);
            border: 1px solid rgba(16,185,129,0.4);
            color: var(--success);
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
            margin-top: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .data-quality-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(16,185,129,0.3);
        }
        .data-quality-badge::before {
            content: '';
            width: 16px;
            height: 16px;
            background: var(--success);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            animation: checkPulse 2s ease-in-out infinite;
        }
        @keyframes checkPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }
        .data-quality-badge.medium {
            background: rgba(251,191,36,0.2);
            border-color: rgba(251,191,36,0.4);
            color: var(--gold);
        }
        .data-quality-badge.medium::before {
            content: '!';
            background: var(--gold);
        }
        .data-quality-badge.medium:hover {
            box-shadow: 0 4px 12px rgba(251,191,36,0.3);
        }
        .data-quality-badge.low {
            background: rgba(239,68,68,0.2);
            border-color: rgba(239,68,68,0.4);
            color: var(--danger);
        }
        .data-quality-badge.low::before {
            content: '';
            background: var(--danger);
        }
        .data-quality-badge.low:hover {
            box-shadow: 0 4px 12px rgba(239,68,68,0.3);
        }
        .prediction-certainty { font-size: 11px; line-height: 1.6; margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.15); border-radius: var(--radius-sm); }
        .limitations-note { font-size: 10px; color: var(--text-dim); margin-top: 10px; padding: 8px; background: rgba(239,68,68,0.1); border-radius: var(--radius-sm); border-right: 2px solid var(--danger); }

        /* Disclaimer box - CRITICAL INFO */
        .disclaimer-box {
            background: linear-gradient(135deg, rgba(239,68,68,0.12), rgba(220,38,38,0.08));
            border: 2px solid rgba(239,68,68,0.4);
            border-radius: var(--radius-md);
            padding: 16px 18px;
            margin-top: 20px;
            margin-bottom: 12px;
            box-shadow: 0 4px 12px rgba(239,68,68,0.15);
            font-size: 10px;
            line-height: 1.7;
            color: var(--text-muted);
        }
        .disclaimer-title {
            font-size: 11px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .disclaimer-list {
            list-style: none;
            margin: 8px 0 0 0;
            padding: 0;
        }
        .disclaimer-list li {
            padding: 4px 0 4px 20px;
            position: relative;
        }
        .disclaimer-list li::before {
            content: '•';
            position: absolute;
            left: 8px;
            color: var(--warning);
        }

        /* אזהרת תיקון אוטומטי */
        .auto-fix-warning {
            background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(251,191,36,0.1));
            border: 2px solid rgba(245,158,11,0.4);
            border-radius: var(--radius-md);
            padding: 12px 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: warningPulse 2s ease-in-out infinite;
        }
        @keyframes warningPulse {
            0%, 100% { box-shadow: 0 0 0 rgba(245,158,11,0); }
            50% { box-shadow: 0 0 20px rgba(245,158,11,0.4); }
        }
        .auto-fix-icon {
            width: 32px;
            height: 32px;
            background: var(--warning);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }
        .auto-fix-text {
            flex: 1;
            font-size: 11px;
            line-height: 1.6;
            color: var(--text);
        }
        .auto-fix-text strong {
            color: var(--warning);
            font-size: 12px;
        }

        .probability-section { margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.08); }
        .prob-label { font-size: 10px; color: var(--text-muted); margin-bottom: 6px; }
        .probability-bar { display: flex; height: 8px; border-radius: 4px; overflow: hidden; margin-bottom: 6px; }
        .prob-home { background: linear-gradient(90deg, var(--success), #34d399); }
        .prob-draw { background: var(--text-dim); }
        .prob-away { background: linear-gradient(90deg, #f87171, var(--danger)); }
        .prob-labels { display: flex; justify-content: space-between; font-size: 10px; }
        .prob-home-label { color: var(--success); font-weight: 600; }
        .prob-draw-label { color: var(--text-dim); }
        .prob-away-label { color: var(--danger); font-weight: 600; }

        .factors-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 14px; padding-top: 14px; border-top: 1px solid rgba(255,255,255,0.06); }
        .factor-item { text-align: center; }
        .factor-icon { font-size: 18px; margin-bottom: 4px; }
        .factor-bar { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-bottom: 4px; position: relative; overflow: hidden; }
        .factor-bar::after { content: ''; position: absolute; left: 0; top: 0; height: 100%; width: var(--value); background: linear-gradient(90deg, var(--primary), var(--accent)); border-radius: 2px; }
        .factor-label { font-size: 9px; color: var(--text-muted); }

        .ai-tag { display: inline-flex; align-items: center; gap: 5px; background: linear-gradient(135deg, rgba(139,92,246,0.2), rgba(59,130,246,0.15)); color: #a78bfa; font-size: 9px; font-weight: 700; padding: 5px 10px; border-radius: 15px; margin-top: 10px; border: 1px solid rgba(139,92,246,0.3); }
        .card-footer { display: flex; gap: 8px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.06); }
        .stat-chip { flex: 1; background: rgba(0,0,0,0.3); padding: 8px; border-radius: var(--radius-sm); text-align: center; }
        .stat-chip-label { font-size: 8px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 3px; }
        .stat-chip-value { font-size: 12px; font-weight: 700; font-family: var(--font-mono); }

        .action-buttons { display: flex; gap: 6px; justify-content: center; flex-wrap: wrap; }
        .action-btn { width: 30px; height: 30px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.15); background: rgba(0,0,0,0.3); color: var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 11px; transition: var(--transition); }
        .action-btn:hover { background: rgba(255,255,255,0.1); color: var(--text); }
        .action-btn.json-btn:hover { color: var(--accent); border-color: var(--accent); }
        .action-btn.refresh-btn:hover { color: var(--success); border-color: var(--success); }
        .action-btn.save-btn:hover { color: var(--gold); border-color: var(--gold); }

        /*
           EMPTY STATE – מצב ריק
            */
        .empty-state {
            text-align: center;
            padding: 70px 30px;
            color: var(--text-muted);
            grid-column: 1 / -1;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05));
            border-radius: 24px;
            border: 2px dashed rgba(99, 102, 241, 0.2);
        }

        .brain-pulse-container {
            display: inline-block;
            position: relative;
            margin-bottom: 30px;
        }

        .brain-icon-pulse {
            font-size: 80px;
            background: linear-gradient(135deg, var(--primary), var(--secondary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: brainPulse 2s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(99, 102, 241, 0.3));
        }

        @keyframes brainPulse {
            0%, 100% {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
            50% {
                transform: scale(1.1) translateY(-5px);
                opacity: 0.9;
            }
        }

        .empty-icon { font-size: 64px; margin-bottom: 20px; background: linear-gradient(135deg, var(--primary), var(--secondary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        .empty-title {
            font-size: 26px;
            font-weight: 800;
            color: var(--text);
            margin-bottom: 12px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .empty-desc {
            font-size: 14px;
            line-height: 1.8;
            max-width: 450px;
            margin: 0 auto 30px;
            color: var(--text-muted);
        }

        .empty-features {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
            margin-top: 25px;
        }

        .empty-feature {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .empty-feature:hover {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--primary);
            transform: translateY(-3px);
        }

        .empty-feature i {
            font-size: 24px;
            color: var(--primary);
        }

        .empty-feature span {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
        }

        /* 
           LOADING OVERLAY – מסך טעינה
            */
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(2,6,23,0.97); backdrop-filter: blur(30px); display: none; align-items: center; justify-content: center; z-index: 9999; flex-direction: column; gap: 20px; }
        .loading-overlay.active { display: flex; }
        .neural-loader { width: 100px; height: 100px; position: relative; }
        .neural-loader::before, .neural-loader::after { content: ''; position: absolute; border-radius: 50%; }
        .neural-loader::before { width: 100%; height: 100%; border: 4px solid transparent; border-top-color: var(--primary); border-right-color: var(--secondary); animation: neuralSpin 1.5s linear infinite; }
        .neural-loader::after { width: 70%; height: 70%; top: 15%; left: 15%; border: 4px solid transparent; border-bottom-color: var(--accent); border-left-color: var(--gold); animation: neuralSpin 1s linear infinite reverse; }
        @keyframes neuralSpin { to { transform: rotate(360deg); } }
        .neural-core { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 28px; animation: corePulse 1s ease-in-out infinite; }
        @keyframes corePulse { 0%, 100% { opacity: 1; transform: translate(-50%, -50%) scale(1); } 50% { opacity: 0.5; transform: translate(-50%, -50%) scale(0.85); } }
        .loading-text { font-size: 16px; font-weight: 700; text-align: center; }
        .loading-subtext { font-size: 12px; color: var(--text-muted); font-family: var(--font-mono); }
        .progress-container { width: 280px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent)); background-size: 200% 100%; animation: progressMove 2s linear infinite; width: 0%; transition: width 0.3s; }
        @keyframes progressMove { 0% { background-position: 100% 0; } 100% { background-position: 0 0; } }

        /* 
           RESPONSIVE – התאמה למסכים קטנים
            */
        @media (max-width: 1200px) { .content { grid-template-columns: 1fr; } .control-panel { position: relative; } }
        @media (max-width: 768px) {
            .top-bar { padding: 0 20px; }
            .content { padding: 20px; }
            .results-grid { grid-template-columns: 1fr; }
            .status-area { display: none; }
            .factors-grid { grid-template-columns: repeat(2, 1fr); }
        }

        /* 
            AI POPUP NEXT-LEVEL – חלון AI אינטראקטיבי וחכם
            */
        .ai-popup-overlay {
            display: none; position: fixed; inset: 0;
            background: linear-gradient(135deg, rgba(2,6,23,0.97), rgba(15,23,42,0.95));
            backdrop-filter: blur(25px) saturate(180%); z-index: 10000;
            align-items: center; justify-content: center;
        }
        .ai-popup-overlay.show { display: flex; animation: overlayFadeIn 0.5s ease; }
        @keyframes overlayFadeIn { from { opacity: 0; backdrop-filter: blur(0); } to { opacity: 1; backdrop-filter: blur(25px); } }

        /* מעטפת ראשית - עיצוב חלק ומודרני */
        .ai-popup-content {
            background: linear-gradient(145deg, rgba(30,41,59,0.96), rgba(15,23,42,0.98));
            border: 1px solid rgba(139,92,246,0.3);
            position: relative;
            border-radius: 18px;
            padding: 0;
            max-width: 420px;
            width: 85%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 25px 70px rgba(139,92,246,0.5), 0 0 50px rgba(59,130,246,0.2), inset 0 1px 1px rgba(255,255,255,0.1);
            animation: popupEntrance 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .ai-popup-content::-webkit-scrollbar {
            width: 6px;
        }
        .ai-popup-content::-webkit-scrollbar-track {
            background: rgba(15,23,42,0.5);
        }
        .ai-popup-content::-webkit-scrollbar-thumb {
            background: rgba(139,92,246,0.5);
            border-radius: 3px;
        }
        .ai-popup-content::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 20px;
            padding: 1.5px;
            background: linear-gradient(135deg, var(--secondary), var(--primary), var(--accent), var(--gold));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            animation: borderFlow 8s linear infinite;
            opacity: 0.8;
        }
        @keyframes borderFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes popupEntrance {
            0% { transform: scale(0.92) translateY(-30px); opacity: 0; filter: blur(10px); }
            100% { transform: scale(1) translateY(0); opacity: 1; filter: blur(0); }
        }

        /* כותרת עליונה עם לוגו */
        .ai-popup-header {
            background: linear-gradient(135deg, rgba(139,92,246,0.2), rgba(59,130,246,0.15));
            padding: 20px 25px 15px;
            border-bottom: 1px solid rgba(139,92,246,0.3);
            position: relative;
        }
        .ai-popup-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--gold), var(--warning));
            color: #000;
            font-size: 10px;
            font-weight: 900;
            padding: 5px 12px;
            border-radius: 20px;
            margin-bottom: 10px;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            box-shadow: 0 4px 15px rgba(251,191,36,0.4);
            animation: badgePulse 2s ease-in-out infinite;
        }
        @keyframes badgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* אייקון מרכזי מרשים */
        .ai-popup-icon-wrapper {
            position: relative;
            display: inline-block;
            margin: 12px 0;
        }
        .ai-popup-icon {
            font-size: 70px;
            display: inline-block;
            animation: iconFloat 3s ease-in-out infinite, iconRotatePopup 20s linear infinite;
            filter: drop-shadow(0 10px 30px rgba(139,92,246,0.6));
        }
        @keyframes iconFloat {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-20px) scale(1.1); }
        }
        @keyframes iconRotatePopup {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .ai-popup-icon-ring {
            position: absolute;
            inset: -20px;
            border: 3px solid transparent;
            border-top-color: var(--primary);
            border-right-color: var(--secondary);
            border-radius: 50%;
            animation: ringRotate 3s linear infinite;
        }
        @keyframes ringRotate {
            100% { transform: rotate(360deg); }
        }

        /* כותרת מרכזית */
        .ai-popup-title {
            font-size: 28px;
            font-weight: 900;
            background: linear-gradient(135deg, var(--gold), var(--warning), var(--primary), var(--secondary));
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0;
            font-family: var(--font-display);
            letter-spacing: 2px;
            text-transform: uppercase;
            animation: gradientFlow 5s ease infinite;
        }
        @keyframes gradientFlow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* גוף הפופאפ */
        .ai-popup-body {
            padding: 25px 30px;
        }
        .ai-popup-message {
            font-size: 15px;
            color: var(--text);
            line-height: 1.7;
            margin-bottom: 20px;
            font-weight: 600;
        }
        .ai-popup-features {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        .ai-popup-feature {
            background: rgba(139,92,246,0.1);
            border: 1px solid rgba(139,92,246,0.3);
            padding: 12px 8px;
            border-radius: 12px;
            transition: all 0.3s;
        }
        .ai-popup-feature:hover {
            background: rgba(139,92,246,0.2);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(139,92,246,0.3);
        }
        .ai-popup-feature-icon {
            font-size: 28px;
            margin-bottom: 6px;
            display: block;
        }
        .ai-popup-feature-text {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 700;
            line-height: 1.3;
        }

        /* הודעה מצחיקה */
        .ai-popup-funny {
            background: linear-gradient(135deg, rgba(251,191,36,0.15), rgba(245,158,11,0.1));
            border: 1px solid rgba(251,191,36,0.3);
            border-radius: 14px;
            padding: 15px 18px;
            margin: 20px 0;
            font-size: 13px;
            color: var(--text);
            line-height: 1.6;
            font-style: italic;
            position: relative;
        }
        .ai-popup-funny::before {
            content: '';
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
            background: var(--bg-panel);
            padding: 4px;
            border-radius: 50%;
        }

        /* כפתורים מרשימים */
        .ai-popup-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }
        .ai-popup-btn {
            flex: 1;
            background: linear-gradient(135deg, #10b981, #34d399);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 14px;
            font-weight: 800;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 10px 30px rgba(16,185,129,0.5);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            position: relative;
            overflow: hidden;
        }
        .ai-popup-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, transparent, rgba(255,255,255,0.3), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }
        .ai-popup-btn:hover::before {
            transform: translateX(100%);
        }
        .ai-popup-btn:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 18px 50px rgba(16,185,129,0.7);
        }
        .ai-popup-btn.secondary {
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        .ai-popup-btn.secondary:hover {
            box-shadow: 0 12px 35px rgba(0,0,0,0.5);
        }

        /* תוצאה */
        .ai-popup-result {
            margin-top: 25px;
            padding: 20px;
            background: linear-gradient(145deg, rgba(16,185,129,0.15), rgba(59,130,246,0.1));
            border: 2px solid rgba(16,185,129,0.4);
            border-radius: 16px;
            display: none;
            animation: resultSlideIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes resultSlideIn {
            from { opacity: 0; transform: translateY(30px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .ai-popup-result h3 {
            font-size: 20px;
            color: var(--gold);
            margin-bottom: 15px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }
        .ai-popup-result p {
            font-size: 14px;
            color: var(--text);
            line-height: 1.7;
            margin-bottom: 12px;
        }
        .ai-popup-result .match-display {
            font-size: 16px;
            font-weight: 800;
            color: var(--gold);
            margin: 15px 0;
            text-shadow: 0 0 20px rgba(251,191,36,0.4);
        }
        .ai-popup-result .score-display {
            font-size: 38px;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 12px 0;
            font-family: var(--font-display);
        }
        .ai-popup-result .funny-note {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 15px;
            padding: 14px;
            background: rgba(0,0,0,0.4);
            border-radius: 10px;
            line-height: 1.6;
            border-left: 3px solid var(--gold);
        }

        /* טוען מיוחד */
        .ai-popup-loading {
            display: none;
            margin: 20px 0;
        }
        .ai-popup-loading.active {
            display: block;
        }
        .ai-popup-loading-spinner {
            width: 50px;
            height: 50px;
            margin: 0 auto 12px;
            border: 3px solid rgba(139,92,246,0.2);
            border-top-color: var(--primary);
            border-right-color: var(--secondary);
            border-radius: 50%;
            animation: spinLoader 1s linear infinite;
        }
        @keyframes spinLoader {
            100% { transform: rotate(360deg); }
        }
        .ai-popup-loading-text {
            font-size: 13px;
            color: var(--text-muted);
            font-family: var(--font-mono);
        }

        /* כפתור סגירה */
        .ai-popup-close {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: rgba(239,68,68,0.2);
            border: 2px solid rgba(239,68,68,0.4);
            color: var(--danger);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s;
            z-index: 10;
        }
        .ai-popup-close:hover {
            background: var(--danger);
            color: white;
            transform: rotate(90deg) scale(1.1);
            box-shadow: 0 8px 25px rgba(239,68,68,0.5);
        }

        /* רספונסיבי */
        @media (max-width: 768px) {
            .ai-popup-content { max-width: 95%; padding: 0; }
            .ai-popup-body { padding: 20px 18px; }
            .ai-popup-title { font-size: 22px; }
            .ai-popup-icon { font-size: 60px; }
            .ai-popup-message { font-size: 14px; }
            .ai-popup-features { grid-template-columns: 1fr; gap: 8px; }
            .ai-popup-actions { flex-direction: column; }
            .ai-popup-btn { font-size: 13px; padding: 12px 18px; }
        }

        /* 
           v9.1 BLUEPRINT UI COMPONENTS
            */

        /* Value Score Badge */
        .value-score-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, rgba(34,211,238,0.15), rgba(59,130,246,0.1));
            border: 1px solid rgba(34,211,238,0.3);
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 11px;
            font-weight: 700;
            color: var(--accent);
            font-family: var(--font-mono);
        }
        .value-score-badge i { font-size: 12px; }
        .value-score-badge.high-value {
            border-color: rgba(16,185,129,0.4);
            background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(34,211,238,0.1));
            color: var(--success);
        }
        .value-score-badge.low-value {
            border-color: rgba(148,163,184,0.3);
            background: linear-gradient(135deg, rgba(148,163,184,0.1), rgba(100,116,139,0.05));
            color: var(--text-muted);
        }

        /* Scenario Badge */
        .scenario-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(251,191,36,0.1);
            border: 1px solid rgba(251,191,36,0.3);
            border-radius: 18px;
            padding: 5px 11px;
            font-size: 10px;
            font-weight: 700;
            color: var(--gold);
        }

        /* MVP Markets Styles – Step 4 */
        .mvp-market-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            transition: var(--transition);
        }
        .mvp-market-item:hover {
            background: rgba(0, 0, 0, 0.4);
            transform: translateY(-2px);
        }
        .mvp-market-icon {
            font-size: 24px;
            min-width: 32px;
            text-align: center;
        }
        .mvp-market-content {
            flex: 1;
        }
        .mvp-market-type {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .mvp-market-prediction {
            font-size: 14px;
            font-weight: 700;
            color: var(--text);
            margin: 4px 0;
        }
        .mvp-market-confidence {
            font-size: 10px;
            color: var(--text-dim);
            font-family: var(--font-mono);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Explainability Card - TITAN v2.0 */
        .explainability-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.10));
            border: 1.5px solid rgba(102, 126, 234, 0.3);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-top: 16px;
            animation: fadeIn 0.5s ease-in;
        }
        .explainability-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }
        .explainability-header h4 {
            margin: 0;
            font-size: 16px;
            color: var(--text);
        }
        .explainability-badge {
            background: rgba(102, 126, 234, 0.2);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            color: rgba(102, 126, 234, 1);
            font-weight: 600;
        }
        .explainability-drivers, .explainability-xg {
            margin-bottom: 12px;
        }
        .explainability-drivers-title, .explainability-reducers-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text);
        }
        .explainability-driver, .explainability-reducer {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 10px;
            margin-bottom: 6px;
            border-radius: 6px;
            border-left: 3px solid #10b981;
            transition: transform 0.2s;
            font-size: 11px;
        }
        .driver-icon {
            font-size: 16px;
            flex-shrink: 0;
        }
        .driver-text, .reducer-text {
            flex: 1;
        }
        .explainability-reducer {
            border-left-color: #ef4444;
        }
        .explainability-driver:hover, .explainability-reducer:hover {
            transform: translateX(4px);
            background: rgba(255, 255, 255, 0.08);
        }
        .driver-impact, .reducer-impact {
            background: #10b981;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 11px;
        }
        .reducer-impact {
            background: #ef4444;
        }
        .explainability-xg h5 {
            margin: 0 0 10px 0;
            font-size: 13px;
            color: var(--text);
        }
        .xg-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .xg-team {
            min-width: 70px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text);
        }
        .xg-bar-container {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            height: 20px;
            overflow: hidden;
        }
        .xg-bar-home, .xg-bar-away {
            height: 100%;
            border-radius: 8px;
            transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .xg-bar-home {
            background: linear-gradient(90deg, #10b981, #34d399);
        }
        .xg-bar-home::after, .xg-bar-away::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        .xg-bar-away {
            background: linear-gradient(90deg, #ef4444, #f87171);
        }
        .xg-value {
            min-width: 40px;
            text-align: right;
            font-weight: 600;
            font-size: 13px;
            color: var(--text);
        }
        .xg-total {
            margin-top: 8px;
            text-align: center;
            font-size: 12px;
            color: var(--text-muted);
        }
        .xg-total strong {
            color: var(--text);
        }
        .explainability-impact {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .impact-label {
            color: var(--text-muted);
        }
        .impact-value {
            font-size: 20px;
            font-weight: 700;
        }
        .impact-indicator {
            font-size: 14px;
        }

        /* v9.1 Disclaimer Box */
        .v91-disclaimer {
            background: linear-gradient(135deg, rgba(239,68,68,0.08), rgba(245,158,11,0.05));
            border: 1.5px solid rgba(239,68,68,0.3);
            border-radius: var(--radius-md);
            padding: 14px 16px;
            margin-top: 14px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            font-size: 10px;
            line-height: 1.7;
            color: var(--text);
        }
        .v91-disclaimer-icon {
            width: 32px;
            height: 32px;
            background: rgba(239,68,68,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }
        .v91-disclaimer-content { flex: 1; }
        .v91-disclaimer-title {
            font-weight: 800;
            color: var(--danger);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
            font-size: 10px;
        }
        .v91-disclaimer-text {
            color: var(--text-muted);
            line-height: 1.8;
        }

        /* Analysis Short/Full Toggle */
        .analysis-toggle-section {
            background: linear-gradient(135deg, rgba(139,92,246,0.08), rgba(59,130,246,0.05));
            border: 1px solid rgba(139,92,246,0.2);
            border-radius: var(--radius-md);
            padding: 14px;
            margin-top: 10px;
        }
        .analysis-short-content {
            font-size: 12px;
            line-height: 1.8;
            color: var(--text);
            margin-bottom: 10px;
        }
        .analysis-full-placeholder {
            background: linear-gradient(135deg, rgba(251,191,36,0.1), rgba(245,158,11,0.05));
            border: 1px solid rgba(251,191,36,0.25);
            border-radius: var(--radius-sm);
            padding: 12px 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .analysis-full-placeholder-icon {
            font-size: 20px;
        }
        .analysis-full-placeholder-text {
            flex: 1;
            font-size: 11px;
            line-height: 1.6;
        }
        .analysis-full-placeholder-title {
            font-weight: 700;
            color: var(--gold);
            margin-bottom: 3px;
        }
        .analysis-full-placeholder-desc {
            color: var(--text-muted);
            font-size: 10px;
        }

        /* v9.1 Version Badge (Top Bar) */
        .v91-version-badge {
            background: linear-gradient(135deg, rgba(34,211,238,0.2), rgba(59,130,246,0.15));
            border: 1px solid rgba(34,211,238,0.35);
            color: var(--accent);
            font-size: 9px;
            font-weight: 800;
            padding: 4px 10px;
            border-radius: 15px;
            margin-left: 10px;
            font-family: var(--font-mono);
            letter-spacing: 0.5px;
        }

        /* ════════════════════════════════════════════════════════════
           CTO CARD STYLING – תצוגה פשוטה ומקצועית
           ════════════════════════════════════════════════════════════ */
        .cto-card {
            background: linear-gradient(145deg, rgba(30,41,59,0.6), rgba(15,23,42,0.8));
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: var(--radius-lg);
            padding: 28px;
            margin-bottom: 20px;
            position: relative;
            animation: cardIn 0.4s ease forwards;
            opacity: 0;
            line-height: 1.8;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .cto-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(99,102,241,0.2);
            border-color: rgba(99,102,241,0.3);
        }

        .cto-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .cto-header {
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 16px;
            margin-bottom: 24px;
        }

        .depth-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-right: 8px;
        }

        .depth-badge.deep {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(99, 102, 241, 0.2));
            color: var(--secondary);
            border: 1px solid rgba(139, 92, 246, 0.4);
        }

        .depth-badge.standard {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.2));
            color: var(--primary);
            border: 1px solid rgba(59, 130, 246, 0.4);
        }

        .depth-badge i {
            font-size: 8px;
        }

        .cto-meta {
            color: var(--text-muted);
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .cto-teams {
            font-size: 24px;
            font-weight: 700;
            color: var(--text);
        }

        .cto-section {
            margin-bottom: 20px;
        }

        .cto-section-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .cto-section-content {
            color: var(--text);
            font-size: 15px;
            line-height: 1.8;
        }

        .cto-prediction {
            display: flex;
            align-items: baseline;
            gap: 12px;
            font-size: 18px;
        }

        .cto-score {
            font-size: 28px;
            font-weight: 700;
            color: var(--success);
            font-family: var(--font-mono);
        }

        .cto-confidence {
            color: var(--text-muted);
            font-size: 16px;
        }

        .cto-markets {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .cto-markets li {
            padding: 6px 0;
            color: var(--text);
            font-size: 15px;
        }

        .cto-markets li::before {
            content: '• ';
            color: var(--accent);
            font-weight: bold;
            margin-left: 8px;
        }

        .cto-verdict {
            background: rgba(96,165,250,0.1);
            border-right: 3px solid var(--primary);
            padding: 14px 18px;
            border-radius: 8px;
            color: var(--text);
            font-size: 15px;
            line-height: 1.7;
        }

        /* ════════════════════════════════════════════════════════════════════════════ */
        /* ✨ NEW V2 RESULT CARD - 4-SECTION STRATEGIC REDESIGN */
        /* ════════════════════════════════════════════════════════════════════════════ */

        .result-card-v2 {
            background: linear-gradient(145deg, rgba(30,41,59,0.95), rgba(15,23,42,0.98));
            border: 2px solid rgba(59, 130, 246, 0.2);
            border-radius: 20px;
            padding: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            animation: cardIn 0.5s ease forwards;
            opacity: 0;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .result-card-v2::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899);
            animation: shimmer 3s infinite;
        }

        .result-card-v2:hover {
            transform: translateY(-8px);
            border-color: rgba(59, 130, 246, 0.4);
            box-shadow: 0 20px 60px rgba(59, 130, 246, 0.2);
        }

        .card-close-btn-v2 {
            position: absolute;
            top: 16px;
            left: 16px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(239,68,68,0.2);
            border: 2px solid rgba(239,68,68,0.4);
            color: #ef4444;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.3s;
            z-index: 20;
        }

        .card-close-btn-v2:hover {
            background: #ef4444;
            color: white;
            transform: rotate(90deg);
        }

        /* ═══════════════════════════════════════════════════════════════════════════ */
        /* 1️⃣ HERO SECTION */
        /* ═══════════════════════════════════════════════════════════════════════════ */

        .hero-section {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(139, 92, 246, 0.1));
            padding: 32px 28px;
            border-bottom: 2px solid rgba(255,255,255,0.05);
        }

        .hero-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .league-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(251, 191, 36, 0.2);
            border: 1px solid rgba(251, 191, 36, 0.4);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 800;
            color: #fbbf24;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .date-badge {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 6px 14px;
            border-radius: 15px;
            font-size: 10px;
            color: var(--text-muted);
            font-weight: 600;
        }

        .hero-matchup {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 24px;
            margin-bottom: 28px;
        }

        .hero-team {
            flex: 1;
            text-align: center;
            transition: all 0.3s;
        }

        .hero-team.winning {
            transform: scale(1.05);
        }

        .hero-team .team-name {
            font-size: 22px;
            font-weight: 900;
            color: var(--text);
            line-height: 1.2;
        }

        .hero-team.winning .team-name {
            color: #fbbf24;
            text-shadow: 0 0 20px rgba(251, 191, 36, 0.4);
        }

        .hero-vs {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-muted);
            padding: 8px 16px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
        }

        .hero-prediction {
            text-align: center;
            margin-bottom: 28px;
        }

        .prediction-score {
            font-size: 56px;
            font-weight: 900;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-family: var(--font-display);
            letter-spacing: 6px;
            line-height: 1;
            margin-bottom: 12px;
        }

        .prediction-winner {
            font-size: 24px;
            font-weight: 800;
            padding: 12px 24px;
            border-radius: 15px;
            display: inline-block;
        }

        .prediction-winner.winner-home {
            background: linear-gradient(135deg, rgba(16,185,129,0.2), rgba(16,185,129,0.1));
            border: 2px solid rgba(16,185,129,0.4);
            color: #10b981;
        }

        .prediction-winner.winner-away {
            background: linear-gradient(135deg, rgba(239,68,68,0.2), rgba(239,68,68,0.1));
            border: 2px solid rgba(239,68,68,0.4);
            color: #ef4444;
        }

        .prediction-winner.winner-draw {
            background: linear-gradient(135deg, rgba(148,163,184,0.2), rgba(148,163,184,0.1));
            border: 2px solid rgba(148,163,184,0.4);
            color: #94a3b8;
        }

        .hero-confidence {
            text-align: center;
            margin-bottom: 24px;
        }

        .confidence-circle {
            width: 120px;
            height: 120px;
            margin: 0 auto 16px;
            position: relative;
        }

        .confidence-circle svg {
            width: 100%;
            height: 100%;
        }

        .confidence-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 32px;
            font-weight: 900;
            color: var(--text);
        }

        .confidence-label {
            font-size: 13px;
            color: var(--text-muted);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .hero-probs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .prob-item {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 16px 12px;
            text-align: center;
            transition: all 0.3s;
        }

        .prob-item.active {
            background: rgba(59, 130, 246, 0.15);
            border-color: rgba(59, 130, 246, 0.4);
            transform: scale(1.05);
        }

        .prob-value {
            font-size: 24px;
            font-weight: 900;
            color: var(--text);
            margin-bottom: 6px;
        }

        .prob-label {
            font-size: 10px;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
        }

        /* ═══════════════════════════════════════════════════════════════════════════ */
        /* 2️⃣ REASONING SECTION */
        /* ═══════════════════════════════════════════════════════════════════════════ */

        .reasoning-section {
            padding: 28px;
            background: rgba(0,0,0,0.2);
            border-bottom: 2px solid rgba(255,255,255,0.05);
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 800;
            color: var(--text);
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .section-title i {
            color: #3b82f6;
            font-size: 20px;
        }

        .reasoning-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .reason-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            gap: 14px;
            align-items: center;
            transition: all 0.3s;
        }

        .reason-card:hover {
            transform: translateY(-3px);
            border-color: rgba(255,255,255,0.2);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }

        .reason-icon {
            font-size: 32px;
            min-width: 40px;
        }

        .reason-content {
            flex: 1;
        }

        .reason-title {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-muted);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .reason-bar {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 6px;
        }

        .reason-bar-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 1s ease;
        }

        .reason-value {
            font-size: 16px;
            font-weight: 900;
            color: var(--text);
        }

        .reasoning-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 16px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .engine-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid rgba(139, 92, 246, 0.4);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 800;
            color: #a78bfa;
        }

        .data-points {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-muted);
        }

        /* ═══════════════════════════════════════════════════════════════════════════ */
        /* 3️⃣ RISK FACTORS SECTION */
        /* ═══════════════════════════════════════════════════════════════════════════ */

        .risk-section {
            padding: 28px;
            background: rgba(0,0,0,0.15);
            border-bottom: 2px solid rgba(255,255,255,0.05);
        }

        .risk-level {
            background: rgba(255,255,255,0.03);
            border: 2px solid;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 16px;
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .risk-indicator {
            width: 12px;
            height: 60px;
            border-radius: 6px;
        }

        .risk-content {
            flex: 1;
        }

        .risk-title {
            font-size: 16px;
            font-weight: 800;
            color: var(--text);
            margin-bottom: 6px;
        }

        .risk-subtitle {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.5;
        }

        .risk-factors {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .risk-factor {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 10px;
            padding: 14px 16px;
            display: flex;
            gap: 14px;
            align-items: center;
        }

        .risk-factor.warning {
            background: rgba(239,68,68,0.1);
            border-color: rgba(239,68,68,0.3);
        }

        .risk-factor-icon {
            font-size: 24px;
            min-width: 30px;
        }

        .risk-factor-text {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.6;
        }

        .risk-factor-text strong {
            color: var(--text);
            font-weight: 800;
        }

        /* ═══════════════════════════════════════════════════════════════════════════ */
        /* 4️⃣ SECONDARY PREDICTIONS SECTION */
        /* ═══════════════════════════════════════════════════════════════════════════ */

        .secondary-section {
            padding: 28px;
            background: rgba(0,0,0,0.1);
        }

        .secondary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .secondary-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(139, 92, 246, 0.05));
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
        }

        .secondary-card:hover {
            transform: translateY(-5px);
            border-color: rgba(59, 130, 246, 0.4);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.15);
        }

        .secondary-icon {
            font-size: 36px;
            margin-bottom: 12px;
        }

        .secondary-title {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-muted);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .secondary-prediction {
            font-size: 18px;
            font-weight: 900;
            color: var(--text);
            margin-bottom: 10px;
        }

        .secondary-confidence {
            font-size: 10px;
            color: var(--text-muted);
            line-height: 1.5;
        }

        /* ═══════════════════════════════════════════════════════════════════════════ */
        /* CARD FOOTER V2 */
        /* ═══════════════════════════════════════════════════════════════════════════ */

        .card-footer-v2 {
            padding: 20px 28px;
            background: rgba(0,0,0,0.3);
            display: flex;
            gap: 12px;
            justify-content: center;
            border-top: 2px solid rgba(255,255,255,0.05);
        }

        .action-btn-v2 {
            flex: 1;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text);
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .action-btn-v2:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
        }

        .action-btn-v2.primary {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border-color: transparent;
            color: white;
        }

        .action-btn-v2.primary:hover {
            background: linear-gradient(135deg, #2563eb, #7c3aed);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .hero-matchup {
                flex-direction: column;
                gap: 12px;
            }

            .hero-team .team-name {
                font-size: 18px;
            }

            .prediction-score {
                font-size: 42px;
            }

            .reasoning-grid,
            .secondary-grid {
                grid-template-columns: 1fr;
            }

            .card-footer-v2 {
                flex-wrap: wrap;
            }

            .action-btn-v2 {
                flex: 1 1 45%;
            }
        }
    </style>
    <!-- 🔐 בדיקת מנוי -->
    <script src="auth-check.js"></script>
</head>
<body>
<div class="bg-gradient"></div>

<!-- SVG Gradient for confidence rings -->
<svg width="0" height="0">
    <defs>
        <linearGradient id="confidenceGradient" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" style="stop-color:#3b82f6"/>
            <stop offset="50%" style="stop-color:#8b5cf6"/>
            <stop offset="100%" style="stop-color:#06b6d4"/>
        </linearGradient>
    </defs>
</svg>

<!-- Toast Container – הודעות מערכת -->
<div class="toast-container" id="toastContainer"></div>

<!-- Loading Overlay – מסך טעינה -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="neural-loader"><div class="neural-core"></div></div>
    <div class="loading-text"><span id="loadingTitle">מנוע TITAN ULTIMATE מעבד...</span><div class="loading-subtext" id="loadingSubtext">אנליזה algorithm AI מתקדמת</div></div>
    <div class="progress-container"><div class="progress-fill" id="progressBar"></div></div>
</div>

<!-- Sidebar Navigation -->
<nav class="sidebar">
    <div class="logo-area">
        <i class="fas fa-brain logo-icon"></i>
        <div class="logo-text">SMARTSPORTS</div>
    </div>

    <div class="nav-group">
        <div class="nav-title">ראשי</div>
        <a href="/index.html" class="nav-item">
            <i class="fas fa-home"></i>
            <span>דף הבית</span>
        </a>
        <a href="/predictions.html" class="nav-item active">
            <i class="fas fa-brain"></i>
            <span>תחזיות AI</span>
        </a>
        <a href="/news.html" class="nav-item">
            <i class="fas fa-newspaper"></i>
            <span>חדשות ספורט</span>
        </a>
    </div>

    <div class="nav-group">
        <div class="nav-title">משחקים</div>
        <a href="/game_arena.html" class="nav-item">
            <i class="fas fa-gamepad"></i>
            <span>משחקים בכיף AI</span>
        </a>
    </div>

    <div class="nav-group">
        <div class="nav-title">כלים</div>
        <a href="/about.html" class="nav-item">
            <i class="fas fa-info-circle"></i>
            <span>אודות</span>
        </a>
        <a href="/API_documentation.html" class="nav-item">
            <i class="fas fa-code"></i>
            <span>תיעוד API</span>
        </a>
        <a href="/help_center.html" class="nav-item">
            <i class="fas fa-envelope"></i>
            <span>מרכז העזרה</span>
        </a>
    </div>

    <div class="nav-group">
        <div class="nav-title">משתמש</div>
        <a href="/login.html" class="nav-item" id="loginBtn">
            <i class="fas fa-sign-in-alt"></i>
            <span>התחברות</span>
        </a>
        <a href="/profile.html" class="nav-item" id="profileBtn" style="display:none;">
            <i class="fas fa-user-circle"></i>
            <span>הפרופיל שלי</span>
        </a>
        <a href="#" class="nav-item" id="logoutBtn" style="display:none;" onclick="logout(); return false;">
            <i class="fas fa-sign-out-alt"></i>
            <span>התנתקות</span>
        </a>
    </div>
</nav>

<!--
     MAIN AREA – אזור ראשי
      -->
<main class="main-area">
    <header class="top-bar">
        <div class="page-title">
            <h1><i class="fa-solid fa-rocket"></i> SMARTSPORT AI Platform</h1>
            <span>Enterprise-Grade Predictions • GPT-4o Engine • Real-Time API Integration</span>
        </div>
        <div class="status-area">
            <div class="ai-badge" id="aiStatusBadge"><i class="fa-solid fa-atom"></i><span id="aiStatusText">בודק...</span></div>
            <div class="status-badge"><div class="pulsing-dot"></div>מקוון</div>
        </div>
    </header>

    <div class="content">
        <!--
             CONTROL PANEL – לוח בקרה
              -->
        <div class="control-panel glass-panel">
            <!-- 🚀 STARTUP HEADER -->
            <div style="text-align: center; margin-bottom: 20px; padding-bottom: 18px; border-bottom: var(--border);">
                <div style="font-size: 24px; font-weight: 800; font-family: var(--font-display); background: linear-gradient(135deg, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px;">
                    TITAN AI ENGINE
                </div>
                <div style="display: flex; gap: 8px; justify-content: center; align-items: center; margin-bottom: 10px;">
                    <span style="background: linear-gradient(135deg, rgba(16,185,129,0.2), rgba(5,150,105,0.1)); border: 1px solid rgba(16,185,129,0.4); color: var(--success); font-size: 9px; font-weight: 800; padding: 3px 8px; border-radius: 12px; font-family: var(--font-mono);">
                        <i class="fa-solid fa-bolt"></i> GPT-4o POWERED
                    </span>
                    <span style="background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(37,99,235,0.1)); border: 1px solid rgba(59,130,246,0.4); color: var(--primary); font-size: 9px; font-weight: 800; padding: 3px 8px; border-radius: 12px; font-family: var(--font-mono);">
                        <i class="fa-solid fa-database"></i> REAL-TIME API
                    </span>
                    <span style="background: linear-gradient(135deg, rgba(251,191,36,0.2), rgba(245,158,11,0.1)); border: 1px solid rgba(251,191,36,0.4); color: var(--gold); font-size: 9px; font-weight: 800; padding: 3px 8px; border-radius: 12px; font-family: var(--font-mono);">
                        <i class="fa-solid fa-chart-line"></i> 10-DIM ANALYSIS
                    </span>
                </div>
                <div style="font-size: 11px; color: var(--text-muted); line-height: 1.5;">
                    פלטפורמת ניתוח AI מתקדמת לתחזיות ספורט מקצועיות
                </div>
            </div>

            <!-- MODE SELECTOR – בחירת מצב -->
            <div class="mode-selector">
                <div class="mode-card active" data-mode="league" onclick="switchMode('league')">
                    <div class="mode-icon">⚽</div>
                    <div class="mode-title">ליגה ותאריך</div>
                    <div class="mode-desc">בחר ליגה וקבוצות</div>
                </div>
                <div class="mode-card" data-mode="custom" onclick="switchMode('custom')">
                    <div class="mode-icon">✨</div>
                    <div class="mode-title">משחק מותאם</div>
                    <div class="mode-desc">כל קבוצה מכל מדינה</div>
                </div>
                <div class="mode-card" data-mode="batch" onclick="switchMode('batch')">
                    <div class="mode-icon">🔥</div>
                    <div class="mode-title">4 ניתוחים</div>
                    <div class="mode-desc">עד 4 משחקים</div>
                </div>
            </div>

            <!-- בחירת עומק ניתוח -->
            <div class="form-group">
                <label>
                    <i class="fa-solid fa-layer-group"></i> עומק ניתוח
                    <span class="help-tooltip" title="ניתוח רגיל: 6-8 משפטים ממוקדים | ניתוח עמוק: 10-12 משפטים מקיפים עם פירוט טקטי מלא">
                        <i class="fa-solid fa-circle-info"></i>
                    </span>
                </label>
                <select id="analysisDepthSelect" onchange="onDepthChange()">
                    <option value="standard" selected>⚡ רגיל – ניתוח ממוקד (6-8 משפטים)</option>
                    <option value="deep">🔬 עמוק – ניתוח מקיף (10-12 משפטים)</option>
                </select>
            </div>

            <!-- 
                 MODE: LEAGUE – ליגה ותאריך
                  -->
            <div class="mode-content active" id="mode-league">
                <div class="form-group">
                    <label><i class="fa-solid fa-futbol"></i> בחר ליגה</label>
                    <select id="leagueSelect" onchange="onLeagueChange()">
                        <option value="">-- טוען ליגות... --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label><i class="fa-solid fa-shield"></i> קבוצה ביתית</label>
                    <select id="homeTeamSelect">
                        <option value="">-- בחר קבוצה ביתית --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label><i class="fa-solid fa-shield-halved"></i> קבוצה אורחת</label>
                    <select id="awayTeamSelect">
                        <option value="">-- בחר קבוצה אורחת --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label><i class="fa-solid fa-calendar-day"></i> תאריך</label>
                    <input type="date" id="dateSelect">
                </div>
                <button class="btn-main" onclick="generatePrediction()">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> צור תחזית
                </button>
            </div>

            <!-- MODE: CUSTOM – משחק מותאם -->
            <div class="mode-content" id="mode-custom">
                <div style="background: linear-gradient(135deg, rgba(251,191,36,0.1), rgba(245,158,11,0.08)); border: 1px solid rgba(251,191,36,0.2); border-radius: 8px; padding: 8px 10px; margin-bottom: 14px; text-align: center;">
                    <div style="font-size: 12px; font-weight: 700; color: var(--gold);">✨ משחק חלומות – קבוצה מכל מדינה</div>
                </div>
                <div class="form-group">
                    <label><i class="fa-solid fa-shield"></i> קבוצה ביתית</label>
                    <select id="customHomeSelect">
                        <option value="">-- בחר קבוצה --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label><i class="fa-solid fa-shield-halved"></i> קבוצה אורחת</label>
                    <select id="customAwaySelect">
                        <option value="">-- בחר קבוצה --</option>
                    </select>
                </div>
                <button class="btn-main btn-gold" onclick="generateCustomPrediction()">
                    <i class="fa-solid fa-bolt"></i> נתח משחק חלומות
                </button>
                <div class="btn-group">
                    <button class="btn-secondary" onclick="swapTeams('custom')"><i class="fa-solid fa-arrows-rotate"></i> החלף</button>
                    <button class="btn-secondary" onclick="clearCustom()"><i class="fa-solid fa-eraser"></i> נקה</button>
                </div>
            </div>

            <!-- 
                 MODE: BATCH – 4 ניתוחים
                  -->
            <div class="mode-content" id="mode-batch">
                <div class="form-group">
                    <label><i class="fa-solid fa-globe"></i> בחר ליגה</label>
                    <select id="batchLeagueSelect" onchange="onBatchLeagueChange()">
                        <option value="">-- בחר ליגה --</option>
                    </select>
                </div>
                <div class="batch-matches" id="batchMatches"></div>
                <button class="add-match-btn" id="addMatchBtn" onclick="addBatchMatch()">
                    <i class="fa-solid fa-plus"></i> הוסף משחק
                </button>
                <button class="btn-main" onclick="generateBatchPredictions()" style="margin-top:14px;">
                    <i class="fa-solid fa-rocket"></i> נתח הכל
                </button>
            </div>


            <!-- 
                 TERMINAL – טרמינל לוגים
                  -->
            <div class="terminal">
                <div class="terminal-header">
                    <span class="terminal-dot red"></span>
                    <span class="terminal-dot yellow"></span>
                    <span class="terminal-dot green"></span>
                    <span class="terminal-title">TITAN AI v8.0</span>
                </div>
                <div class="terminal-body" id="terminal">
                    <div class="terminal-line"><span class="terminal-prompt">$</span><span class="terminal-ai">TITAN</span> <span class="terminal-text">מאתחל...</span></div>
                </div>
            </div>
        </div>

        <!-- 
             PREDICTIONS VIEW – תצוגת תחזיות
              -->
        <div class="predictions-view glass-panel">
            <div class="view-header">
                <div class="view-title"><i class="fa-solid fa-star"></i> תחזיות</div>
                <div class="view-controls">
                    <button class="view-btn active" onclick="setView('grid')"><i class="fa-solid fa-grip"></i></button>
                    <button class="view-btn" onclick="setView('list')"><i class="fa-solid fa-list"></i></button>
                </div>
            </div>
            <div class="results-grid" id="resultsGrid">
                <div class="empty-state">
                    <div class="brain-pulse-container">
                        <i class="fa-solid fa-brain brain-icon-pulse"></i>
                    </div>
                    <h3 class="empty-title">מוכן לניתוח AI</h3>
                    <p class="empty-desc">בחר ליגה, קבוצה ביתית וקבוצה אורחת<br>כדי לקבל תחזית מקצועית מבוססת TITAN</p>
                    <div class="empty-features">
                        <div class="empty-feature">
                            <i class="fa-solid fa-chart-line"></i>
                            <span>ניתוח טקטי מעמיק</span>
                        </div>
                        <div class="empty-feature">
                            <i class="fa-solid fa-bullseye"></i>
                            <span>תחזית מדויקת</span>
                        </div>
                        <div class="empty-feature">
                            <i class="fa-solid fa-coins"></i>
                            <span>שווקים משלימים</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="ai-popup-overlay" id="aiPopupOverlay">
        <div class="ai-popup-content">
            <!-- כפתור סגירה -->
            <button class="ai-popup-close" onclick="closeAiPopup()" title="סגור">
                <i class="fa-solid fa-times"></i>
            </button>

            <!-- כותרת עליונה -->
            <div class="ai-popup-header">
                <div class="ai-popup-status">
                    <span class="status-indicator"></span>
                    <span class="status-text"> TITAN מחובר ומוכן</span>
                </div>
                <div class="ai-popup-avatar-wrapper">
                    <div class="avatar-ring"></div>
                    <div class="ai-popup-avatar"></div>
                    <div class="avatar-pulse"></div>
                </div>
                <h2 class="ai-popup-greeting" id="aiGreeting">היי! אני TITAN </h2>
                <p class="ai-popup-subtitle">העוזר החכם שלך לתחזיות כדורגל</p>
            </div>

            <!-- גוף הפופאפ -->
            <div class="ai-popup-body">
                <!-- הודעת פתיחה דינמית -->
                <div class="ai-message-box">
                    <div class="message-content" id="aiWelcomeMessage">
                        רגע... אני מזהה שאתה כאן בפעם הראשונה! <br>
                        <strong>תן לי להראות לך משהו מדהים</strong> שיסביר למה משקיעים בנו מיליונים  
                    </div>
                </div>

                <!-- סטטיסטיקות חיות -->
                <div class="ai-stats">
                    <div class="stat-item">
                        <div class="stat-icon"></div>
                        <div class="stat-value">GPT-4o</div>
                        <div class="stat-label">המנוע החזק בעולם</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon"></div>
                        <div class="stat-value" id="statsAnalyses">10D</div>
                        <div class="stat-label">מימדי ניתוח</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon"></div>
                        <div class="stat-value" id="statsUsers">LIVE</div>
                        <div class="stat-label">בזמן אמת</div>
                    </div>
                </div>

                <!-- המלצות חכמות -->
                <div class="ai-suggestions" id="aiSuggestions">
                    <div class="suggestion-title"> בוא נעשה משהו מגניב:</div>
                    <div class="suggestion-buttons">
                        <button class="suggestion-btn" onclick="surpriseMePrediction()">
                            <i class="fa-solid fa-wand-magic-sparkles"></i>
                            <span>הפתע אותי בתחזית!</span>
                        </button>
                        <button class="suggestion-btn" onclick="showTopMatches()">
                            <i class="fa-solid fa-fire"></i>
                            <span>מה חם היום?</span>
                        </button>
                        <button class="suggestion-btn" onclick="location.href='chat.html'">
                            <i class="fa-solid fa-comments"></i>
                            <span>בוא נדבר!</span>
                        </button>
                    </div>
                </div>

                <!-- הודעה מצחיקה מתחלפת -->
                <div class="ai-funny-note">
                    <span id="funnyMessage"> כן כן, אני לא מנבא לוטו... אבל בכדורגל?  אלוף עולם!</span>
                </div>

                <!-- כפתורי פעולה ראשיים -->
                <div class="ai-main-actions">
                    <button class="ai-cta-btn primary" onclick="surpriseMePrediction()">
                        <span class="btn-icon"></span>
                        <span class="btn-text">יאללה תפתיע אותי!</span>
                        <span class="btn-subtitle">תחזית מפתיעה תוך שניות</span>
                    </button>
                    <button class="ai-cta-btn secondary" onclick="location.href='chat.html'" style="background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(139,92,246,0.15)); border: 1px solid rgba(59,130,246,0.3);">
                        <span class="btn-icon"></span>
                        <span class="btn-text" style="font-size: 14px;">בוא נדבר קצת!</span>
                        <span class="btn-subtitle" style="font-size: 11px;">צ'אט אישי עם TITAN</span>
                    </button>
                </div>

                <!-- טוען אינטראקטיבי -->
                <div class="ai-popup-loading" id="aiPopupLoading">
                    <div class="loading-animation">
                        <div class="brain-icon"></div>
                        <div class="thinking-dots">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                    <div class="ai-popup-loading-text">
                        <span id="aiLoadingText">אוקיי, תן לי שנייה...</span>
                    </div>
                </div>

                <!-- תוצאה אינטראקטיבית -->
                <div class="ai-popup-result" id="aiPopupResult"></div>
            </div>
        </div>
    </div>

    <!-- 
         JSON MODAL – חלון תצוגת JSON
          -->
    <div id="jsonModal" style="position:fixed;inset:0;background:rgba(15,23,42,0.85);display:none;align-items:center;justify-content:center;z-index:11000;">
        <div style="background:#020617;border-radius:14px;border:1px solid rgba(148,163,184,0.6);width:min(900px,95vw);max-height:90vh;display:flex;flex-direction:column;box-shadow:0 25px 80px rgba(0,0,0,0.7);">
            <div style="padding:12px 18px;border-bottom:1px solid rgba(51,65,85,0.9);display:flex;align-items:center;justify-content:space-between;font-family:'JetBrains Mono',monospace;font-size:11px;color:#e5e7eb;">
                <span><i class="fa-solid fa-code"></i> RAW JSON VIEW – TITAN RESPONSE</span>
                <button onclick="closeJsonModal()" style="background:none;border:none;color:#9ca3af;cursor:pointer;font-size:14px;"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div style="padding:10px 18px;font-size:11px;color:#9ca3af;">
                <span>קריאה זו מציגה את תשובת ה-AI כפי שהגיעה מהשרת, ללא עיצוב חזותי.</span>
            </div>
            <pre id="jsonModalContent" style="margin:0;padding:16px 18px 18px;overflow:auto;font-size:11px;line-height:1.6;color:#e5e7eb;background:radial-gradient(circle at 10% 0,rgba(59,130,246,0.25),transparent 55%);font-family:'JetBrains Mono',monospace;direction:ltr;text-align:left;white-space:pre;"></pre>
        </div>
    </div>
</main>

<script>
    // 
    // 
    //                         JAVASCRIPT – SMARTSPORTS v8.0
    // 
    // 

    //
    // GLOBAL STATE – משתנים גלובליים
    //
    const API_BASE = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
        ? 'http://127.0.0.1:8000'
        : window.location.origin;   // כתובת בסיס ל-API - משתמש בכתובת הנוכחית
    let dictionary = null;                      // מילון הקבוצות מהשרת
    let currentMode = 'league';                 // מצב נוכחי (league/custom/batch/toto16)
    let batchCount = 0;                         // מונה משחקי batch
    let predictions = [];                       // מערך התחזיות שהוצגו
    let ctoDisplayMode = true;                  // מצב תצוגה CTO פשוט (true) או מלא (false) - ברירת מחדל CTO
    let analysisDepth = 'standard';             // עומק ניתוח (standard/deep)
    let leagueIndex = {};                       // אינדקס ליגות לגישה מהירה
    let allTeamsList = [];                      // רשימת כל הקבוצות מכל הליגות (למצב custom)

    //

    // 
    // UTILITY FUNCTIONS – פונקציות עזר
    // 

    //  תיקון אבטחה #1: escapeHtml - מונע XSS attacks
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = String(text);
        return div.innerHTML;
    }

    function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

    // toggleMobile() removed - sidebar no longer exists

    //
    // TEAM STATISTICS API – סטטיסטיקות קבוצות
    //

    /**
     * קבלת סטטיסטיקות קבוצה מה-API
     * @param {string} teamName - שם הקבוצה
     * @returns {Promise<Object>} סטטיסטיקות מפורטות
     */
    async function getTeamStatistics(teamName) {
        try {
            termLog(`📊 טוען סטטיסטיקות ל-${teamName}...`, 'ai');

            const url = `${API_BASE}/api/team-stats?team=${encodeURIComponent(teamName)}`;
            termLog(`🌐 קורא מ-${url}`, 'ai');

            const response = await fetch(url);
            termLog(`📡 תגובה: status=${response.status}`, response.ok ? 'success' : 'error');

            if (!response.ok) {
                const errorText = await response.text();
                termLog(`❌ שגיאת שרת: ${errorText}`, 'error');
                return null;
            }

            const data = await response.json();

            if (data.success) {
                termLog(`✅ סטטיסטיקות נטענו: ${data.statistics.win_percentage}% ניצחונות`, 'success');
                return data;
            } else {
                termLog(`⚠️ לא נמצאו סטטיסטיקות ל-${teamName}`, 'warning');
                return null;
            }
        } catch (error) {
            console.error('❌ שגיאה מפורטת ב-getTeamStatistics:', error);
            termLog(`❌ שגיאה בטעינת סטטיסטיקות: ${error.message}`, 'error');
            return null;
        }
    }

    /**
     * הצגת סטטיסטיקות קבוצה ב-UI
     * @param {Object} stats - נתוני סטטיסטיקות
     * @returns {string} HTML מעוצב
     */
    function formatTeamStats(stats) {
        if (!stats || !stats.statistics) return '<div style="color: var(--text-muted);">אין נתונים</div>';

        const s = stats.statistics;

        // אייקון כושר
        let formIcon = '🟢';
        let formColor = 'var(--success)';
        if (s.current_form === 'excellent') {
            formIcon = '🔥';
            formColor = '#fbbf24';
        } else if (s.current_form === 'average' || s.current_form === 'poor') {
            formIcon = '🟡';
            formColor = '#f59e0b';
        }

        // 5 משחקים אחרונים
        const last5HTML = s.last_5_matches.map(result => {
            if (result === 'W') return '<span style="color: var(--success);">✓</span>';
            if (result === 'D') return '<span style="color: var(--warning);">−</span>';
            if (result === 'L') return '<span style="color: var(--danger);">✗</span>';
            return result;
        }).join(' ');

        return `
            <div style="padding: 12px; background: rgba(59,130,246,0.05); border: 1px solid rgba(59,130,246,0.2); border-radius: 8px; font-size: 13px;">
                <div style="margin-bottom: 8px;">
                    <strong style="color: var(--primary);">${formIcon} כושר:</strong>
                    <span style="color: ${formColor};">${s.current_form}</span> (${s.form_points})
                </div>
                <div style="margin-bottom: 8px;">
                    <strong style="color: var(--primary);">📊 ניצחונות:</strong> ${s.win_percentage}%
                </div>
                <div style="margin-bottom: 8px;">
                    <strong style="color: var(--primary);">⚽ שערים:</strong> ${s.goals_per_game.scored} | נגד: ${s.goals_per_game.conceded}
                </div>
                <div style="margin-bottom: 8px;">
                    <strong style="color: var(--primary);">5 אחרונים:</strong> ${last5HTML}
                </div>
                ${s.injuries.length > 0 ? `
                    <div style="color: var(--danger); font-size: 12px;">
                        🚑 פציעות: ${s.injuries.length}
                    </div>
                ` : ''}
            </div>
        `;
    }

    function openJsonModal(payload) {
        try {
            const modal = document.getElementById('jsonModal');
            const pre = document.getElementById('jsonModalContent');
            const decorated = {
                match: { home: payload.home, away: payload.away, league: payload.league },
                engine: payload.raw?.metadata?.engine || payload.raw?.engine || 'UNKNOWN',
                timestamp: payload.raw?.metadata?.timestamp || null,
                raw: payload.raw || {}
            };
            pre.textContent = JSON.stringify(decorated, null, 2);
            modal.style.display = 'flex';
        } catch (e) {
            termLog(`JSON Modal Error: ${e.message}`, 'error');
            showToast('error', 'שגיאה', 'לא ניתן להציג JSON כרגע');
        }
    }

    function closeJsonModal() {
        const modal = document.getElementById('jsonModal');
        if (modal) modal.style.display = 'none';
    }

    // 
    // AI POPUP FUNCTIONS – פונקציות AI Popup
    // 

    // פתיחת AI Popup
    function openAiPopup(skipWelcome = false) {
        document.getElementById('aiPopupOverlay').classList.add('show');

        // הצגת מסך ברירת המחדל "מוכן לניתוח AI" - רק אם לא מציגים ברכה
        if (!skipWelcome) {
            const resultDiv = document.getElementById('aiPopupResult');
            if (resultDiv && !resultDiv.innerHTML.trim()) {
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="brain-pulse-container">
                            <i class="fa-solid fa-brain brain-icon-pulse"></i>
                        </div>
                        <h3 class="empty-title">מוכן לניתוח AI</h3>
                        <p class="empty-desc">בחר ליגה, קבוצה ביתית וקבוצה אורחת<br>כדי לקבל תחזית מקצועית מבוססת TITAN</p>
                        <div class="empty-features">
                            <div class="empty-feature">
                                <i class="fa-solid fa-chart-line"></i>
                                <span>ניתוח טקטי מעמיק</span>
                            </div>
                            <div class="empty-feature">
                                <i class="fa-solid fa-bullseye"></i>
                                <span>תחזית מדויקת</span>
                            </div>
                            <div class="empty-feature">
                                <i class="fa-solid fa-coins"></i>
                                <span>שווקים משלימים</span>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        setTimeout(() => {
            if (typeof confetti === 'function') {
                confetti({
                    particleCount: 40,
                    spread: 55,
                    origin: { y: 0.4 }
                });
            }
        }, 300);
        termLog('🎯 פותח AI Popup...', 'ai');
    }

    // סגירת AI Popup
    function closeAiPopup() {
        document.getElementById('aiPopupOverlay').classList.remove('show');
        const resultDiv = document.getElementById('aiPopupResult');
        if (resultDiv) resultDiv.style.display = 'none';
        const loaderDiv = document.getElementById('aiPopupLoading');
        if (loaderDiv) loaderDiv.classList.remove('active');
        termLog('סוגר AI Popup', 'text');
    }

    // 🔥 הודעת ברכה של TITAN בכניסה
    async function showTitanWelcome() {
        const resultDiv = document.getElementById('aiPopupResult');
        if (!resultDiv) return;

        const suggestionsEl = document.getElementById('aiSuggestions');
        if (suggestionsEl) suggestionsEl.style.display = 'none';

        resultDiv.style.display = 'block';

        // אנימציה של טקסט מופיע
        resultDiv.innerHTML = `
            <div style="text-align: center; padding: 20px; animation: fadeIn 0.5s;">
                <div style="font-size: 48px; margin-bottom: 15px;">🔥</div>
                <h2 style="color: var(--primary); margin-bottom: 15px;">היי! אני TITAN</h2>
                <p style="font-size: 18px; color: var(--text); line-height: 1.6; margin-bottom: 20px;">
                    האנליסט AI שלך לספורט! 💪<br>
                    אני כאן כדי לעזור לך להבין משחקים, לנתח קבוצות ולקבל תחזיות מדויקות.
                </p>
                <div style="background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(74,144,226,0.1));
                            border-radius: 12px; padding: 15px; margin: 20px 0; border: 1px solid rgba(255,215,0,0.3);">
                    <p style="font-size: 16px; color: var(--text-muted); margin: 0;">
                        💡 <strong>טיפ היום:</strong> ${getTitanTip()}
                    </p>
                </div>
                <p style="font-size: 14px; color: var(--text-dim); margin-top: 15px;">
                    רוצה לראות משחקים חמים? לשאול על קבוצה? לקבל תחזית? אני כאן! 🚀
                </p>
            </div>
        `;

        termLog('🔥 TITAN מברך את המשתמש!', 'success');
    }

    // טיפים אקראיים של TITAN
    function getTitanTip() {
        const tips = [
            'משחקי דרבי תמיד מלאי הפתעות - הפורמה לא תמיד משנה!',
            'קבוצה שמשחקת בחוץ אחרי משחק אירופאי? שים לב לעייפות 💤',
            'כשיש יתרון גדול בטבלה, זה לא אומר ניצחון אוטומטי! ⚽',
            'פציעות של שחקני מפתח? זה יכול לשנות את כל המשחק! 🏥',
            'משחקים בשעות מוקדמות בבוקר? קבוצות לא תמיד מוכנות... ☕',
            'אל תזלזל בקבוצות קטנות במשחקי גביע - הן באות עם מוטיבציה כפולה! 🏆',
            'יתרון ביתי שווה בערך 0.5 גולים סטטיסטית 🏠',
            'מזג אויר קיצוני? זה משפיע יותר ממה שאתה חושב! 🌧️'
        ];
        return tips[Math.floor(Math.random() * tips.length)];
    }

    // הפתעת תחזית
    async function surpriseMePrediction() {
        const suggestionsEl = document.getElementById('aiSuggestions');
        if (suggestionsEl) suggestionsEl.style.display = 'none';
        await getAiPopupPrediction();
    }

    // משחקים חמים
    async function showTopMatches() {
        const resultDiv = document.getElementById('aiPopupResult');
        if (!resultDiv) return;

        const suggestionsEl = document.getElementById('aiSuggestions');
        if (suggestionsEl) suggestionsEl.style.display = 'none';

        // 🎯 קבלת משחקים אמיתיים מה-API
        try {
            termLog('🔍 טוען משחקים חמים מה-API...', 'ai');
            const response = await fetch(`${API_BASE}/api/today-matches`);
            const data = await response.json();

            if (data.success && data.matches && data.matches.length > 0) {
                const hotMatches = data.matches
                    .filter(m => m.status === 'Not Started' || m.status === 'TBD')
                    .slice(0, 4);

                if (hotMatches.length > 0) {
                    let matchesHTML = hotMatches.map((m) => {
                        const matchDate = new Date(m.date);
                        const timeStr = matchDate.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });

                        return `
                            <div style="background: rgba(139,92,246,0.08); border: 1px solid rgba(139,92,246,0.2); border-radius: 10px; padding: 12px; margin-bottom: 8px; cursor: pointer; transition: all 0.3s;"
                                 onmouseover="this.style.background='rgba(139,92,246,0.15)'"
                                 onmouseout="this.style.background='rgba(139,92,246,0.08)'">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="flex: 1;">
                                        <div style="font-size: 13px; font-weight: 800; color: #e2e8f0;">
                                            ${escapeHtml(m.home_team)} <span style="color: rgba(226,232,240,0.4);">vs</span> ${escapeHtml(m.away_team)}
                                        </div>
                                        <div style="font-size: 10px; color: rgba(226,232,240,0.6);">
                                            ${escapeHtml(m.league)} • ${timeStr}
                                        </div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 11px; font-weight: 700; color: #fbbf24;">
                                            ⚽
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');

                    resultDiv.innerHTML = `
                        <div style="padding: 15px; background: linear-gradient(135deg, rgba(239,68,68,0.1), rgba(251,191,36,0.08)); border: 2px solid rgba(239,68,68,0.25); border-radius: 14px; animation: resultPop 0.5s ease;">
                            <h3 style="font-size: 17px; color: #fbbf24; margin-bottom: 12px; font-weight: 900; text-align: center;">
                                 המשחקים החמים של היום!
                            </h3>
                            <div>${matchesHTML}</div>
                            <div style="margin-top: 15px; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 10px; text-align: center;">
                                <div style="font-size: 11px; color: #e2e8f0; line-height: 1.6;">
                                     <strong>💡</strong> משחקים אמיתיים מה-API בזמן אמת
                                </div>
                            </div>
                        </div>
                    `;
                    resultDiv.style.display = 'block';
                    termLog('✅ משחקים אמיתיים הוצגו מה-API', 'success');
                    return;
                }
            }

            // אם אין משחקים זמינים
            resultDiv.innerHTML = `
                <div style="padding: 15px; background: rgba(255,255,255,0.05); border-radius: 14px; text-align: center;">
                    <div style="font-size: 14px; color: var(--text-muted);">
                        💤 אין משחקים זמינים כרגע
                    </div>
                </div>
            `;
            resultDiv.style.display = 'block';
            termLog('⚠️ לא נמצאו משחקים זמינים', 'warning');
        } catch (error) {
            console.error('Error loading hot matches:', error);
            resultDiv.innerHTML = `
                <div style="padding: 15px; background: rgba(239,68,68,0.1); border: 1px solid var(--danger); border-radius: 14px; text-align: center;">
                    <div style="font-size: 14px; color: var(--danger);">
                        ❌ שגיאה בטעינת משחקים מה-API
                    </div>
                </div>
            `;
            resultDiv.style.display = 'block';
            termLog(`❌ שגיאה: ${error.message}`, 'error');
        }
    }

    // 
    // INITIALIZATION – אתחול המערכת
    // 
    document.addEventListener('DOMContentLoaded', async () => {
        // הגדרת תאריך ברירת מחדל להיום
        document.getElementById('dateSelect').value = new Date().toISOString().split('T')[0];

        // טעינת מילון הקבוצות מהשרת
        await loadDictionary();

        // בדיקת סטטוס AI
        checkAIStatus();

        // הוספת משחק ראשון ל-batch
        addBatchMatch();

        termLog('מערכת מוכנה – v8.0', 'success');

    });

    // 
    // LOAD DICTIONARY – טעינת מילון קבוצות מהשרת
    // 
    async function loadDictionary() {
        try {
            termLog('טוען מילון קבוצות...', 'text');
            const response = await fetch(`${API_BASE}/api/groups-dictionary`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            dictionary = await response.json();
            populateAllLeagueSelects();
            buildAllTeamsList();  // בניית רשימת כל הקבוצות למצב custom
            const leagueCount = Object.keys(dictionary.leagues || {}).length;
            termLog(` נטענו ${leagueCount} ליגות`, 'success');
            showToast('success', 'הצלחה', `${leagueCount} ליגות נטענו מהמערכת`);
        } catch (error) {
            termLog(`שגיאה: ${error.message}`, 'error');
            showToast('error', 'שגיאה', 'טוען נתוני גיבוי...');
            loadFallback();
        }
    }

    // 🚫 נתוני גיבוי מושבתים - העדפה לשגיאה מפורשת על פני נתונים מזויפים
    function loadFallback() {
        dictionary = { leagues: {} };
        termLog('❌ לא ניתן לטעון נתונים מה-API - בדוק חיבור לשרת', 'error');
        showToast('error', 'שגיאת חיבור', 'לא ניתן להתחבר לשרת Backend. נא לבדוק שהשרת פועל.');
    }

    // 
    // BUILD ALL TEAMS LIST – בניית רשימת כל הקבוצות (למצב custom)
    // 
    function buildAllTeamsList() {
        allTeamsList = [];
        const leagues = dictionary?.leagues || {};

        Object.entries(leagues).forEach(([leagueKey, leagueData]) => {
            const countryName = leagueData.name || leagueData.country || '';
            const competitions = leagueData.competitions || [];

            competitions.forEach((comp) => {
                const teams = comp.teams || [];
                teams.forEach(team => {
                    const teamName = typeof team === 'string' ? team : team.name;
                    allTeamsList.push({
                        name: teamName,
                        country: countryName,
                        league: comp.name || comp.englishName
                    });
                });
            });
        });

        // מילוי select של משחק מותאם עם כל הקבוצות
        populateCustomTeamSelects();
        termLog(`נבנתה רשימת ${allTeamsList.length} קבוצות למצב מותאם`, 'success');
    }

    // מילוי select של משחק מותאם
    function populateCustomTeamSelects() {
        const homeSelect = document.getElementById('customHomeSelect');
        const awaySelect = document.getElementById('customAwaySelect');

        let options = '<option value="">-- בחר קבוצה מכל מדינה --</option>';

        // קיבוץ לפי מדינה
        const byCountry = {};
        allTeamsList.forEach(t => {
            if (!byCountry[t.country]) byCountry[t.country] = [];
            byCountry[t.country].push(t);
        });

        Object.entries(byCountry).forEach(([country, teams]) => {
            options += `<optgroup label=" ${country}">`;
            teams.forEach(t => {
                options += `<option value="${t.name}">${t.name}</option>`;
            });
            options += `</optgroup>`;
        });

        homeSelect.innerHTML = options;
        awaySelect.innerHTML = options;
    }

    // מילוי כל ה-select של ליגות
    function populateAllLeagueSelects() {
        const leagues = dictionary?.leagues || {};
        let options = '<option value="">-- בחר ליגה/מפעל --</option>';
        leagueIndex = {};

        Object.entries(leagues).forEach(([leagueKey, leagueData]) => {
            const countryName = leagueData.name || leagueData.country || '';
            const competitions = leagueData.competitions || [];

            competitions.forEach((comp) => {
                const compId = comp.id || `${leagueKey}-default`;
                const displayName = comp.name || comp.englishName || compId;
                const compositeKey = `${leagueKey}__${compId}`;

                leagueIndex[compositeKey] = {
                    leagueKey, competitionId: compId, leagueName: displayName,
                    competitionName: displayName, englishName: comp.englishName || displayName, countryName
                };

                options += `<option value="${compositeKey}"> ${displayName} (${countryName})</option>`;
            });
        });

        document.getElementById('leagueSelect').innerHTML = options;
        document.getElementById('batchLeagueSelect').innerHTML = options;
    }

    // 
    // LEAGUE MODE HANDLERS – טיפול במצב ליגה
    // 
    function onLeagueChange() {
        const leagueCompositeKey = document.getElementById('leagueSelect').value;
        populateTeamSelects(leagueCompositeKey, 'homeTeamSelect', 'awayTeamSelect');
    }

    function onBatchLeagueChange() {
        const leagueCompositeKey = document.getElementById('batchLeagueSelect').value;
        updateAllBatchSelects(leagueCompositeKey);
    }

    function getCompetitionByCompositeKey(compositeKey) {
        if (!compositeKey) return null;
        const meta = leagueIndex[compositeKey];
        if (!meta) return null;
        const leagueData = dictionary.leagues[meta.leagueKey];
        if (!leagueData) return null;
        return (leagueData.competitions || []).find(c => (c.id || '').toLowerCase() === meta.competitionId.toLowerCase()) || null;
    }

    function populateTeamSelects(compositeKey, homeSelectId, awaySelectId) {
        const homeSelect = document.getElementById(homeSelectId);
        const awaySelect = document.getElementById(awaySelectId);
        const competition = getCompetitionByCompositeKey(compositeKey);

        if (!competition) {
            homeSelect.innerHTML = '<option value="">-- בחר ליגה קודם --</option>';
            awaySelect.innerHTML = '<option value="">-- בחר ליגה קודם --</option>';
            return;
        }

        const teams = competition.teams || [];
        let options = '<option value="">-- בחר קבוצה --</option>';
        teams.forEach(team => {
            const teamName = typeof team === 'string' ? team : team.name;
            options += `<option value="${teamName}">${teamName}</option>`;
        });

        homeSelect.innerHTML = options;
        awaySelect.innerHTML = options;
        termLog(`נטענו ${teams.length} קבוצות מ-${competition.name}`, 'success');
    }

    function updateAllBatchSelects(compositeKey) {
        const competition = getCompetitionByCompositeKey(compositeKey);
        if (!competition) return;

        const teams = competition.teams || [];
        let options = '<option value="">בחר קבוצה</option>';
        teams.forEach(team => {
            const teamName = typeof team === 'string' ? team : team.name;
            options += `<option value="${teamName}">${teamName}</option>`;
        });

        document.querySelectorAll('.batch-team-select').forEach(select => {
            const currentVal = select.value;
            select.innerHTML = options;
            if (currentVal) select.value = currentVal;
        });

        termLog(`קבוצות עודכנו לכל המשחקים עבור ${competition.name}`, 'success');
    }

    // שינוי עומק ניתוח
    function onDepthChange() {
        const sel = document.getElementById('analysisDepthSelect');
        analysisDepth = sel.value || 'standard';
        termLog(`עומק ניתוח עודכן ל: ${analysisDepth}`, 'text');
    }

    // החלפת מצב (league/custom/batch/toto16)
    function switchMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.mode-card').forEach(c => c.classList.toggle('active', c.dataset.mode === mode));
        document.querySelectorAll('.mode-content').forEach(c => c.classList.toggle('active', c.id === `mode-${mode}`));
        termLog(`מצב: ${mode}`, 'text');
    }

    // 
    // BATCH MODE HANDLERS – טיפול במצב batch
    // 
    function addBatchMatch() {
        if (batchCount >= 4) {
            showToast('warning', 'מקסימום', 'ניתן להוסיף עד 4 משחקים');
            return;
        }

        batchCount++;
        const html = `
        <div class="batch-match" id="batchMatch${batchCount}">
            <div class="batch-match-header">
                <span class="batch-match-title">משחק ${batchCount}</span>
                <button class="batch-match-remove" onclick="removeBatch(${batchCount})"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="batch-match-teams">
                <select class="batch-team-select" id="batchHome${batchCount}"><option value="">בחר קבוצה</option></select>
                <span class="batch-vs">VS</span>
                <select class="batch-team-select" id="batchAway${batchCount}"><option value="">בחר קבוצה</option></select>
            </div>
        </div>`;
        document.getElementById('batchMatches').insertAdjacentHTML('beforeend', html);

        const leagueKey = document.getElementById('batchLeagueSelect').value;
        if (leagueKey) updateAllBatchSelects(leagueKey);
        updateAddBtn();
    }

    function removeBatch(idx) {
        document.getElementById(`batchMatch${idx}`)?.remove();
        batchCount--;
        updateAddBtn();
    }

    function updateAddBtn() {
        const btn = document.getElementById('addMatchBtn');
        btn.disabled = batchCount >= 4;
        btn.innerHTML = batchCount >= 4 ? '<i class="fa-solid fa-check"></i> מקסימום' : `<i class="fa-solid fa-plus"></i> הוסף משחק (${batchCount}/4)`;
    }

    //
    // TOTO 16 UI – יצירת ממשק טוטו 16 עם נתונים אמיתיים
    //
    async function renderToto16UI() {
        const container = document.getElementById('toto16Container');

        // אם אין משחקים, נטען אותם מה-API
        if (toto16Games.length === 0) {
            try {
                termLog('🔍 טוען משחקי טוטו 16 מה-API...', 'ai');
                const response = await fetch(`${API_BASE}/api/today-matches`);
                const data = await response.json();

                if (data.success && data.matches && data.matches.length >= 16) {
                    // לוקחים 16 משחקים קרובים
                    const upcoming = data.matches
                        .filter(m => m.status === 'Not Started' || m.status === 'TBD')
                        .slice(0, 16);

                    toto16Games = upcoming.map((m, idx) => ({
                        id: idx + 1,
                        home: m.home_team,
                        away: m.away_team,
                        league: m.league,
                        matchId: m.match_id,
                        aiPick: null,
                        userPick: null
                    }));

                    termLog(`✅ נטענו ${toto16Games.length} משחקים לטוטו 16`, 'success');
                } else {
                    termLog('⚠️ לא נמצאו מספיק משחקים לטוטו 16', 'warning');
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">אין מספיק משחקים זמינים כרגע</div>';
                    return;
                }
            } catch (error) {
                console.error('Error loading toto games:', error);
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--danger);">❌ שגיאה בטעינת משחקים</div>';
                return;
            }
        }

        container.innerHTML = '';

        toto16Games.forEach((game, idx) => {
            const row = document.createElement('div');
            row.className = 'toto-game-row';
            row.id = `toto-row-${game.id}`;

            row.innerHTML = `
                <div class="toto-game-num">${game.id}</div>
                <div class="toto-teams">
                    <div class="home">${escapeHtml(game.home)}</div>
                    <div class="away">vs ${escapeHtml(game.away)}</div>
                </div>
                <div class="toto-picks">
                    <button class="toto-pick-btn" data-game="${game.id}" data-pick="1" onclick="setTotoPick(${game.id}, '1')">1</button>
                    <button class="toto-pick-btn" data-game="${game.id}" data-pick="X" onclick="setTotoPick(${game.id}, 'X')">X</button>
                    <button class="toto-pick-btn" data-game="${game.id}" data-pick="2" onclick="setTotoPick(${game.id}, '2')">2</button>
                </div>
            `;

            container.appendChild(row);
        });

        updateTotoSummary();
    }

    // בחירת 1/X/2 במשחק טוטו
    function setTotoPick(gameId, pick) {
        const game = toto16Games.find(g => g.id === gameId);
        if (game) {
            game.userPick = pick;
        }

        // עדכון UI
        const row = document.getElementById(`toto-row-${gameId}`);
        row.querySelectorAll('.toto-pick-btn').forEach(btn => {
            btn.classList.remove('selected');
            if (btn.dataset.pick === pick) {
                btn.classList.add('selected');
            }
        });

        updateTotoSummary();
        termLog(`טוטו משחק ${gameId}: נבחר ${pick}`, 'success');
    }

    // עדכון סיכום טוטו
    function updateTotoSummary() {
        const adopted = toto16Games.filter(g => g.userPick || g.aiPick).length;
        document.getElementById('totoAiAdopted').textContent = adopted;
    }

    // 
    // RUN TOTO 16 AI – הפעלת AI על כל 16 המשחקים
    // 
    async function runToto16AI() {
        showLoading(true);
        termLog('מפעיל AI על 16 משחקי טוטו...', 'ai');

        for (const game of toto16Games) {
            try {
                // קריאה ל-API לכל משחק
                const pred = await fetchPrediction(game.home, game.away, game.league, null, 'standard');

                if (pred && pred.prediction) {
                    const score = pred.prediction.score || '';
                    const parts = score.split('-').map(s => parseInt(s.trim(), 10));

                    if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                        if (parts[0] > parts[1]) {
                            game.aiPick = '1';
                        } else if (parts[1] > parts[0]) {
                            game.aiPick = '2';
                        } else {
                            game.aiPick = 'X';
                        }
                    } else {
                        game.aiPick = 'X';
                    }

                    // אם המשתמש לא בחר עדיין, נאמץ את בחירת ה-AI
                    if (!game.userPick) {
                        game.userPick = game.aiPick;
                    }

                    // עדכון UI
                    const row = document.getElementById(`toto-row-${game.id}`);
                    row.querySelectorAll('.toto-pick-btn').forEach(btn => {
                        btn.classList.remove('selected', 'ai-pick');
                        if (btn.dataset.pick === game.aiPick) {
                            btn.classList.add('ai-pick');
                        }
                        if (btn.dataset.pick === game.userPick) {
                            btn.classList.add('selected');
                        }
                    });
                }

                // השהייה קטנה בין קריאות
                await delay(200);

            } catch (e) {
                termLog(`שגיאה במשחק ${game.id}: ${e.message}`, 'error');
            }
        }

        updateTotoSummary();
        showLoading(false);
        showToast('success', 'הושלם!', 'AI מילא את טופס טוטו 16');
        confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
    }

    // 
    // COPY TOTO 16 TO CLIPBOARD – העתקת הטופס ללוח
    // 
    function copyToto16ToClipboard() {
        const lines = toto16Games.map(g => {
            const finalPick = g.userPick || g.aiPick || '-';
            return `משחק ${g.id}: ${g.home} vs ${g.away} → ${finalPick}`;
        });

        const text = ` טופס טוטו 16 חכם – SMARTSPORTS\n${''.repeat(40)}\n${lines.join('\n')}\n${''.repeat(40)}\nנוצר ע"י SMARTSPORTS AI`;

        navigator.clipboard.writeText(text)
            .then(() => {
                showToast('success', 'הועתק!', 'הטופס הועתק ללוח – הדבק אותו באתר הטוטו');
                termLog('טופס טוטו 16 הועתק ללוח', 'success');
            })
            .catch(() => {
                showToast('error', 'שגיאה', 'לא הצלחנו להעתיק ללוח');
            });
    }

    // 
    // PREDICTIONS – יצירת תחזיות
    // 
    async function generatePrediction() {
        const leagueCompositeKey = document.getElementById('leagueSelect').value;
        const home = document.getElementById('homeTeamSelect').value;
        const away = document.getElementById('awayTeamSelect').value;
        const matchDate = document.getElementById('dateSelect').value || null;

        if (!leagueCompositeKey) { showToast('warning', 'שים לב', 'בחר ליגה/מפעל'); return; }
        if (!home) { showToast('warning', 'שים לב', 'בחר קבוצה ביתית'); return; }
        if (!away) { showToast('warning', 'שים לב', 'בחר קבוצה אורחת'); return; }
        if (home === away) { showToast('warning', 'שים לב', 'הקבוצות חייבות להיות שונות'); return; }

        const meta = leagueIndex[leagueCompositeKey];
        const leagueNameForAI = meta ? (meta.englishName || meta.competitionName) : 'General';
        await fetchAndDisplay(home, away, leagueNameForAI, matchDate, analysisDepth);
    }

    // תחזית למשחק מותאם (custom) – ללא ליגה
    async function generateCustomPrediction() {
        const home = document.getElementById('customHomeSelect').value;
        const away = document.getElementById('customAwaySelect').value;

        if (!home || !away) { showToast('warning', 'שים לב', 'בחר שתי קבוצות'); return; }
        if (home === away) { showToast('warning', 'שים לב', 'הקבוצות חייבות להיות שונות'); return; }

        // מציאת הליגה של כל קבוצה (לצורך הצגה)
        const homeTeam = allTeamsList.find(t => t.name === home);
        const awayTeam = allTeamsList.find(t => t.name === away);
        const leagueLabel = homeTeam && awayTeam
            ? `${homeTeam.country} vs ${awayTeam.country}`
            : 'משחק חלומות';

        await fetchAndDisplay(home, away, leagueLabel, null, analysisDepth);
    }

    async function generateBatchPredictions() {
        const leagueCompositeKey = document.getElementById('batchLeagueSelect').value;
        if (!leagueCompositeKey) { showToast('warning', 'שים לב', 'בחר ליגה/מפעל'); return; }

        const matches = [];
        for (let i = 1; i <= 4; i++) {
            const homeEl = document.getElementById(`batchHome${i}`);
            const awayEl = document.getElementById(`batchAway${i}`);
            if (homeEl && awayEl && homeEl.value && awayEl.value && homeEl.value !== awayEl.value) {
                matches.push({ home: homeEl.value, away: awayEl.value });
            }
        }

        if (matches.length === 0) { showToast('warning', 'שים לב', 'הגדר לפחות משחק אחד'); return; }

        const meta = leagueIndex[leagueCompositeKey];
        const leagueNameForAI = meta ? (meta.englishName || meta.competitionName) : 'General';

        showLoading(true);
        try {
            const results = await fetchBatchPredictions(matches, leagueNameForAI, analysisDepth);
            if (!results || results.length === 0) {
                showToast('warning', 'אין תוצאות', 'לא התקבלו תחזיות מהשרת');
                return;
            }
            displayResults(results);
            const avgConf = Math.round(results.reduce((acc, r) => acc + (r.confidence || 0), 0) / results.length);
            showToast('success', 'Batch הושלם', `${results.length} תחזיות • ממוצע ביטחון ${avgConf}%`);
            termLog(`Batch Summary: ${results.length} משחקים, ממוצע ביטחון ${avgConf}%`, 'success');
            confetti({ particleCount: 120, spread: 80, origin: { y: 0.6 } });
        } catch (e) {
            showToast('error', 'שגיאה', e.message);
            termLog(`Batch Fatal Error: ${e.message}`, 'error');
        } finally {
            showLoading(false);
        }
    }

    async function fetchAndDisplay(home, away, league, matchDate = null, depth = 'standard') {
        showLoading(true);
        try {
            const pred = await fetchPrediction(home, away, league, matchDate, depth);
            if (pred) {
                displayResults([pred]);
                showToast('success', 'הושלם', 'התחזית נוצרה בהצלחה');
                confetti({ particleCount: 80, spread: 60, origin: { y: 0.6 } });
            }
        } catch (e) {
            showToast('error', 'שגיאה', e.message);
        } finally {
            showLoading(false);
        }
    }

    // 
    // FETCH PREDICTION – קריאה ל-API לקבלת תחזית
    // 
    async function fetchPrediction(home, away, league, matchDate = null, depth = 'standard') {
        termLog(`🔄 מנתח: ${home} vs ${away} (${league}) | עומק: ${depth}`, 'ai');
        termLog(`🌐 API URL: ${API_BASE}/api/predict`, 'ai');

        const payload = { home, away, league, depth, match_date: matchDate || undefined };
        termLog(`📤 שולח payload: ${JSON.stringify(payload)}`, 'ai');

        try {
            const res = await fetch(`${API_BASE}/api/predict`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            termLog(`📥 תגובה מהשרת: status=${res.status} ok=${res.ok}`, res.ok ? 'success' : 'error');

            if (!res.ok) {
                const errorText = await res.text();
                termLog(`❌ שגיאת שרת: ${errorText}`, 'error');
                throw new Error(`HTTP ${res.status}: ${errorText}`);
            }

            const data = await res.json();
            termLog(`✅ תחזית: ${data.prediction?.score || '?'} | מנצחת: ${data.prediction?.winner || '?'}`, 'success');

            //  תיקון: משתמשים בנתונים מהשרת, לא בפרמטרים שנשלחו
            const matchData = data.match || {};

            return {
                home: matchData.home || home,
                away: matchData.away || away,
                league: matchData.league || league,
                prediction: data.prediction || {},
                insight: data.insight || '',
                insight_en: data.insight_en || '',
                confidence: data.prediction?.confidence || 70,
                factors: data.factors || {},
                momentum: data.momentum || {},
                h2h: data.h2h || [],
                extended_stats: data.extended_stats || {},
                risk_level: data.risk_level || 'MEDIUM',
                recommendations: data.recommendations || [],
                aiMode: (data.data_source && data.data_source.mode) || (data.metadata && data.metadata.engine) || 'TITAN_AI',
                raw: data,
                depth: depth  // שמירת עומק הניתוח לשימוש מאוחר יותר
            };
        } catch (e) {
            console.error('❌ שגיאה מפורטת ב-fetchPrediction:', e);
            termLog(`❌ שגיאה: ${e.message}`, 'error');
            termLog(`⚠️ עובר למצב Fallback (ללא חיבור API)`, 'warning');
            return fallbackPrediction(home, away, league, depth);
        }
    }

    // תחזית גיבוי במקרה של שגיאה
    function fallbackPrediction(home, away, league, depth = 'standard') {
        const h = Math.floor(Math.random() * 4);
        const a = Math.floor(Math.random() * 3);
        const conf = 60 + Math.floor(Math.random() * 25);
        const winner = h > a ? home : (a > h ? away : 'תיקו');

        return {
            home, away, league,
            prediction: { score: `${h}-${a}`, winner: winner, confidence: conf },
            insight: generateSmartInsight({ home, away, confidence: conf, factors: { home_advantage: 70, form: 68, attack: 72, defense: 65 }, depth }),
            confidence: conf,
            factors: { form: 70, h2h: 65, home_advantage: 72, attack: 70, defense: 68 },
            aiMode: 'FALLBACK',
            depth: depth
        };
    }

    // קריאת batch לתחזיות מרובות
    async function fetchBatchPredictions(matches, leagueNameForAI, depth = 'standard') {
        termLog(`Batch Mode: שולח ${matches.length} משחקים לניתוח מרוכז | עומק: ${depth}`, 'ai');

        try {
            const payload = {
                matches: matches.map(m => ({ home: m.home, away: m.away, league: leagueNameForAI })),
                depth: depth
            };

            const res = await fetch(`${API_BASE}/api/predict/batch`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!res.ok) throw new Error(`HTTP ${res.status}`);

            const data = await res.json();
            const allItems = Array.isArray(data.predictions) ? data.predictions : [];
            const items = allItems.filter(p => p && p.success);

            if (items.length === 0) {
                termLog('Batch Mode: לא התקבלו פריטים מוצלחים מהשרת', 'warning');
            } else {
                termLog(`Batch Mode: התקבלו ${items.length} תחזיות בהצלחה`, 'success');
            }

            return items.map(item => {
                const pred = item.prediction || {};
                const matchInfo = pred.match || {};
                const serverMode = (pred.data_source && pred.data_source.mode) || pred.aiMode || pred.engine || 'TITAN_BATCH';

                return {
                    home: matchInfo.home || item.home || '?',
                    away: matchInfo.away || item.away || '?',
                    league: matchInfo.league || leagueNameForAI,
                    prediction: pred.prediction || {},
                    insight: pred.insight || '',
                    confidence: (pred.prediction && pred.prediction.confidence) || 70,
                    factors: pred.factors || {},
                    aiMode: serverMode,
                    raw: pred,
                    depth: depth
                };
            });
        } catch (e) {
            termLog(`Batch Mode Error: ${e.message} — נופל לקריאות בודדות`, 'warning');

            const results = [];
            for (const m of matches) {
                try {
                    const single = await fetchPrediction(m.home, m.away, leagueNameForAI, null, depth);
                    if (single) results.push(single);
                } catch (innerErr) {
                    termLog(`Single Fallback Error (${m.home} vs ${m.away}): ${innerErr.message}`, 'error');
                }
            }
            return results;
        }
    }

    // 
    // DISPLAY RESULTS – הצגת תוצאות
    // 
    function displayResults(newPreds) {
        predictions = [...newPreds, ...predictions].slice(0, 20);
        const grid = document.getElementById('resultsGrid');

        if (!predictions.length) {
            grid.innerHTML = `
                <div class="empty-state">
                    <div class="brain-pulse-container">
                        <i class="fa-solid fa-brain brain-icon-pulse"></i>
                    </div>
                    <h3 class="empty-title">מוכן לניתוח AI</h3>
                    <p class="empty-desc">בחר ליגה, קבוצה ביתית וקבוצה אורחת<br>כדי לקבל תחזית מקצועית מבוססת TITAN</p>
                    <div class="empty-features">
                        <div class="empty-feature">
                            <i class="fa-solid fa-chart-line"></i>
                            <span>ניתוח טקטי מעמיק</span>
                        </div>
                        <div class="empty-feature">
                            <i class="fa-solid fa-bullseye"></i>
                            <span>תחזית מדויקת</span>
                        </div>
                        <div class="empty-feature">
                            <i class="fa-solid fa-trophy"></i>
                            <span>שווקים משלימים</span>
                        </div>
                    </div>
                </div>
            `;
            return;
        }

        // בחר פונקציה בהתאם למצב תצוגה
        grid.innerHTML = predictions.map((p, i) => {
            return ctoDisplayMode ? createCTOCard(p, i) : createCard(p, i);
        }).join('');
    }

    //
    // CREATE CTO CARD – כרטיס תצוגה CTO פשוטה ומקצועית
    //
    function createCTOCard(p, idx) {
        // חלץ נתונים
        const match = p.raw?.match || {};
        const league = p.league || match.league || 'ליגה לא ידועה';
        const date = match.date || new Date().toISOString().split('T')[0];
        const homeTeam = p.home || match.home_team || '';
        const awayTeam = p.away || match.away_team || '';

        // ניתוח
        const analysis = p.raw?.analysis || {};
        const matchOverview = analysis.match_overview || p.insight || 'ניתוח לא זמין';

        // תחזית - נסה קודם מ-prediction של המערכת, אחר כך מ-CTO
        const prediction = p.raw?.prediction || {};
        const mainPrediction = p.prediction || {};

        // התחזית האמיתית - נסה ממספר מקורות
        let finalScore = prediction.final_score || mainPrediction.score || p.score || '1-1';

        // נקה פורמט - אם יש : החלף ב-
        finalScore = finalScore.replace(':', '-');

        const confidenceLevel = prediction.confidence_level || 'medium';

        // תרגום רמת ביטחון
        const confMap = {
            'low': 'נמוכה',
            'medium': 'בינונית',
            'medium-high': 'בינונית–גבוהה',
            'high': 'גבוהה'
        };
        const confText = confMap[confidenceLevel] || 'בינונית';

        // שווקים
        const markets = p.raw?.markets || {};
        const goals = markets.goals || {};
        const goalsType = goals.type || 'Under';
        const goalsLine = goals.line || 2.5;

        const corners = markets.corners || {};
        const cornersRange = corners.expected_range || '7-8';

        const yellowCards = markets.yellow_cards || {};
        const cardsRange = yellowCards.expected_range || '5-6';

        const redCard = markets.red_card || {};
        const redProb = redCard.probability || 'low';
        const redProbHeb = redProb === 'low' ? 'סיכוי נמוך' : redProb === 'medium' ? 'סיכוי בינוני' : 'סיכוי גבוה';

        // סיכום - נסה ממקומות שונים
        const summary = p.raw?.summary || {};
        let verdict = summary.titan_verdict || '';

        // אם אין סיכום - נסה להפיק מהניתוח
        if (!verdict || verdict === 'לא זמין') {
            verdict = matchOverview || 'המשחק צפוי להיות מעניין ומלא אתגרים לשתי הקבוצות.';
        }

        // תג עומק ניתוח
        const depthBadge = p.depth === 'deep'
            ? '<span class="depth-badge deep" title="ניתוח מקיף - 10-12 משפטים"><i class="fa-solid fa-microscope"></i> עמוק</span>'
            : '<span class="depth-badge standard" title="ניתוח ממוקד - 6-8 משפטים"><i class="fa-solid fa-bolt"></i> רגיל</span>';

        return `
            <div class="cto-card" style="animation-delay:${idx * 0.08}s">
                <!-- כפתור X למחיקת כרטיס -->
                <button class="card-close-btn" onclick="removeCard(${idx})" title="מחק כרטיס">
                    <i class="fa-solid fa-times"></i>
                </button>

                <!-- Header -->
                <div class="cto-header">
                    <div class="cto-meta">${league} | ${date} ${depthBadge}</div>
                    <div class="cto-teams">${homeTeam} – ${awayTeam}</div>
                </div>

                <!-- ניתוח המשחק -->
                <div class="cto-section">
                    <div class="cto-section-title">ניתוח המשחק:</div>
                    <div class="cto-section-content">${escapeHtml(matchOverview)}</div>
                </div>

                <!-- תחזית תוצאה -->
                <div class="cto-section">
                    <div class="cto-section-title">תחזית תוצאה:</div>
                    <div class="cto-prediction">
                        <span class="cto-score">${finalScore}</span>
                        <span class="cto-confidence">(רמת ביטחון: ${confText})</span>
                    </div>
                </div>

                <!-- שווקים משלימים -->
                <div class="cto-section">
                    <div class="cto-section-title">שווקים משלימים:</div>
                    <ul class="cto-markets">
                        <li>שערים: ${goalsType} ${goalsLine}</li>
                        <li>קרנות: ${cornersRange}</li>
                        <li>כרטיסים צהובים: ${cardsRange}</li>
                        <li>כרטיס אדום: ${redProbHeb}</li>
                    </ul>
                </div>

                <!-- סיכום TITAN -->
                <div class="cto-section">
                    <div class="cto-section-title">סיכום TITAN:</div>
                    <div class="cto-verdict">${escapeHtml(verdict)}</div>
                </div>
            </div>
        `;
    }

    //
    // CREATE CARD – יצירת כרטיס תחזית מלא (מקורי)
    // לוגיקה מתוקנת: לא דוחפים לתיקו, לא דורסים תוצאה קיימת
    // 

    //
    // ═══════════════════════════════════════════════════════════════════════════════
    // ✨ NEW 4-SECTION PREDICTION RESULT CARD - RAFAEL'S STRATEGIC REDESIGN
    // ═══════════════════════════════════════════════════════════════════════════════
    // Created: 2026-01-30
    // Purpose: Convert users from "just another AI" to "wow, this is serious"
    //
    // STRUCTURE:
    // 1️⃣ HERO SECTION - AI Decision with large probability
    // 2️⃣ REASONING SECTION - Structured factors (NOT free text)
    // 3️⃣ RISK FACTORS - Critical for credibility
    // 4️⃣ SECONDARY PREDICTIONS - Over/Under, BTTS, match scenario
    // ═══════════════════════════════════════════════════════════════════════════════
    function createCard(p, idx) {
        const conf = p.confidence || 70;

        // Calculate score
        let homeGoals = 0, awayGoals = 0;
        const rawScore = (p.prediction && p.prediction.score)
            ? String(p.prediction.score).replace(':', '-')
            : null;

        if (rawScore) {
            const parts = rawScore.split('-').map(s => parseInt(s.trim(), 10));
            if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                homeGoals = parts[0];
                awayGoals = parts[1];
            }
        }

        const hasServerScore = homeGoals !== 0 || awayGoals !== 0;

        if (!hasServerScore) {
            const xgHome = p.factors?.xg_home || p.extended_stats?.xg_data?.home || 0;
            const xgAway = p.factors?.xg_away || p.extended_stats?.xg_data?.away || 0;
            const homeProb = parseFloat(p.prediction?.home_prob || p.raw?.prediction?.home_prob || 33);
            const awayProb = parseFloat(p.prediction?.away_prob || p.raw?.prediction?.away_prob || 33);

            if (xgHome > 0 || xgAway > 0) {
                homeGoals = Math.round(xgHome);
                awayGoals = Math.round(xgAway);
                if (homeProb > awayProb + 20 && homeGoals <= awayGoals) {
                    homeGoals = awayGoals + 1;
                } else if (awayProb > homeProb + 20 && awayGoals <= homeGoals) {
                    awayGoals = homeGoals + 1;
                }
                if (homeGoals === 0 && awayGoals === 0 && (xgHome > 0.5 || xgAway > 0.5)) {
                    if (homeProb > awayProb) {
                        homeGoals = 1;
                        awayGoals = 0;
                    } else if (awayProb > homeProb) {
                        homeGoals = 0;
                        awayGoals = 1;
                    } else {
                        homeGoals = 1;
                        awayGoals = 1;
                    }
                }
            }
        }

        const scoreDisplay = `${homeGoals}-${awayGoals}`;

        // Winner determination
        let displayWinner = '';
        let winnerClass = 'winner-draw';
        if (homeGoals > awayGoals) {
            displayWinner = p.home;
            winnerClass = 'winner-home';
        } else if (awayGoals > homeGoals) {
            displayWinner = p.away;
            winnerClass = 'winner-away';
        } else {
            displayWinner = 'תיקו';
            winnerClass = 'winner-draw';
        }

        if (displayWinner === 'בית' || displayWinner === 'HOME' || displayWinner === 'home') {
            displayWinner = p.home;
        } else if (displayWinner === 'אורח' || displayWinner === 'AWAY' || displayWinner === 'away') {
            displayWinner = p.away;
        }

        // Probabilities
        const factors = p.factors || {};
        const detailedAnalysis = p.raw?.detailed_analysis || {};
        const probBreakdown = detailedAnalysis.probability_breakdown || {};

        let homeProb = probBreakdown.home_win || 0;
        let drawProb = probBreakdown.draw || 0;
        let awayProb = probBreakdown.away_win || 0;

        if (homeProb === 0 && drawProb === 0 && awayProb === 0) {
            if (homeGoals > awayGoals) {
                homeProb = Math.max(conf, 45);
                awayProb = Math.floor((100 - homeProb) * 0.4);
                drawProb = 100 - homeProb - awayProb;
            } else if (awayGoals > homeGoals) {
                awayProb = Math.max(conf, 45);
                homeProb = Math.floor((100 - awayProb) * 0.4);
                drawProb = 100 - homeProb - awayProb;
            } else {
                drawProb = Math.max(conf, 40);
                homeProb = Math.floor((100 - drawProb) / 2);
                awayProb = 100 - drawProb - homeProb;
            }
        }

        const total = homeProb + drawProb + awayProb;
        if (total !== 100 && total > 0) {
            const factor = 100 / total;
            homeProb = Math.round(homeProb * factor);
            drawProb = Math.round(drawProb * factor);
            awayProb = 100 - homeProb - drawProb;
        }

        // Confidence color
        let confColor = '#10b981';
        let confLabel = 'גבוה';
        if (conf < 60) { confColor = '#ef4444'; confLabel = 'נמוך'; }
        else if (conf < 75) { confColor = '#f59e0b'; confLabel = 'בינוני'; }

        // Engine label
        const rawMode = (p.aiMode || '').toString().toUpperCase();
        let engineLabel = 'Logic Engine';
        if (rawMode.includes('TITAN') || rawMode.includes('GPT')) {
            engineLabel = 'TITAN • GPT-4o';
        }

        // Factors
        const attack = factors.attack || 70;
        const defense = factors.defense || 65;
        const form = factors.form || 68;
        const h2h = factors.h2h || factors.head_to_head || 60;

        // Get markets data
        const ctoMarkets = p.raw?.markets || {};
        const goalsData = ctoMarkets.goals || {};
        const goalsType = goalsData.type || 'Over';
        const goalsLine = goalsData.line || 2.5;
        const bttsData = ctoMarkets.btts || {
            prediction: 'Yes',
            reason: 'שתי הקבוצות מציגות יכולת תקיפה טובה'
        };

        // תרגום goalsType לעברית
        const goalsTypeHeb = goalsType === 'Over' ? 'מעל' : 'מתחת ל';

        // תרגום BTTS לעברית
        const bttsHeb = bttsData.prediction === 'Yes' ? 'כן' : 'לא';
        const bttsReasonHeb = bttsData.reason || 'מבוסס על ניתוח יכולות התקיפה';

        // Risk factors
        const riskLevel = p.risk_level || 'MEDIUM';
        let riskColor = '#f59e0b';
        let riskText = 'בינוני';
        if (riskLevel === 'LOW' || conf > 75) {
            riskColor = '#10b981';
            riskText = 'נמוך';
        } else if (riskLevel === 'HIGH' || conf < 60) {
            riskColor = '#ef4444';
            riskText = 'גבוה';
        }

        const safePayload = JSON.stringify({ home: p.home, away: p.away, league: p.league, raw: p.raw || {} }).replace(/'/g, "\\'").replace(/"/g, '&quot;');

        return `
            <div class="result-card-v2" style="animation-delay:${idx * 0.08}s">
                <!-- Close Button -->
                <button class="card-close-btn-v2" onclick="removeCard(${idx})" title="מחק כרטיס">
                    <i class="fa-solid fa-times"></i>
                </button>

                <!-- ═══════════════════════════════════════════════════════════════════ -->
                <!-- 1️⃣ HERO SECTION - AI DECISION -->
                <!-- ═══════════════════════════════════════════════════════════════════ -->
                <div class="hero-section">
                    <div class="hero-header">
                        <div class="league-badge">
                            <i class="fa-solid fa-trophy"></i>
                            ${p.league}
                        </div>
                        <div class="date-badge">
                            ${p.raw?.match?.date || 'עדכני'}
                        </div>
                    </div>

                    <div class="hero-matchup">
                        <div class="hero-team ${homeGoals > awayGoals ? 'winning' : ''}">
                            <div class="team-name">${p.home}</div>
                        </div>
                        <div class="hero-vs">VS</div>
                        <div class="hero-team ${awayGoals > homeGoals ? 'winning' : ''}">
                            <div class="team-name">${p.away}</div>
                        </div>
                    </div>

                    <div class="hero-prediction">
                        <div class="prediction-score">${scoreDisplay}</div>
                        <div class="prediction-winner ${winnerClass}">
                            ${displayWinner}
                        </div>
                    </div>

                    <div class="hero-confidence">
                        <div class="confidence-circle" style="--conf: ${conf}; --conf-color: ${confColor};">
                            <svg viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="45" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="8"/>
                                <circle cx="50" cy="50" r="45" fill="none" stroke="${confColor}" stroke-width="8"
                                    stroke-dasharray="${2 * Math.PI * 45}"
                                    stroke-dashoffset="${2 * Math.PI * 45 * (1 - conf / 100)}"
                                    transform="rotate(-90 50 50)"/>
                            </svg>
                            <div class="confidence-value">${conf}%</div>
                        </div>
                        <div class="confidence-label">רמת ביטחון ${confLabel}</div>
                    </div>

                    <div class="hero-probs">
                        <div class="prob-item ${homeGoals > awayGoals ? 'active' : ''}">
                            <div class="prob-value">${homeProb}%</div>
                            <div class="prob-label">נצחון ${p.home}</div>
                        </div>
                        <div class="prob-item ${homeGoals === awayGoals ? 'active' : ''}">
                            <div class="prob-value">${drawProb}%</div>
                            <div class="prob-label">תיקו</div>
                        </div>
                        <div class="prob-item ${awayGoals > homeGoals ? 'active' : ''}">
                            <div class="prob-value">${awayProb}%</div>
                            <div class="prob-label">נצחון ${p.away}</div>
                        </div>
                    </div>
                </div>

                <!-- ═══════════════════════════════════════════════════════════════════ -->
                <!-- 2️⃣ REASONING SECTION - STRUCTURED FACTORS -->
                <!-- ═══════════════════════════════════════════════════════════════════ -->
                <div class="reasoning-section">
                    <div class="section-title">
                        <i class="fa-solid fa-brain"></i>
                        למה AI חושב כך?
                    </div>

                    <div class="reasoning-grid">
                        <div class="reason-card">
                            <div class="reason-icon">⚔️</div>
                            <div class="reason-content">
                                <div class="reason-title">התקפה</div>
                                <div class="reason-bar">
                                    <div class="reason-bar-fill" style="width: ${attack}%; background: linear-gradient(90deg, #3b82f6, #06b6d4);"></div>
                                </div>
                                <div class="reason-value">${attack}%</div>
                            </div>
                        </div>

                        <div class="reason-card">
                            <div class="reason-icon">🛡️</div>
                            <div class="reason-content">
                                <div class="reason-title">הגנה</div>
                                <div class="reason-bar">
                                    <div class="reason-bar-fill" style="width: ${defense}%; background: linear-gradient(90deg, #10b981, #059669);"></div>
                                </div>
                                <div class="reason-value">${defense}%</div>
                            </div>
                        </div>

                        <div class="reason-card">
                            <div class="reason-icon">📈</div>
                            <div class="reason-content">
                                <div class="reason-title">פורמה</div>
                                <div class="reason-bar">
                                    <div class="reason-bar-fill" style="width: ${form}%; background: linear-gradient(90deg, #a855f7, #7c3aed);"></div>
                                </div>
                                <div class="reason-value">${form}%</div>
                            </div>
                        </div>

                        <div class="reason-card">
                            <div class="reason-icon">⚡</div>
                            <div class="reason-content">
                                <div class="reason-title">היסטוריה (H2H)</div>
                                <div class="reason-bar">
                                    <div class="reason-bar-fill" style="width: ${h2h}%; background: linear-gradient(90deg, #f59e0b, #d97706);"></div>
                                </div>
                                <div class="reason-value">${h2h}%</div>
                            </div>
                        </div>
                    </div>

                    <div class="reasoning-footer">
                        <div class="engine-badge">
                            <i class="fa-solid fa-microchip"></i>
                            ${engineLabel}
                        </div>
                        <div class="data-points">
                            <i class="fa-solid fa-database"></i>
                            350+ נקודות data
                        </div>
                    </div>
                </div>

                <!-- ═══════════════════════════════════════════════════════════════════ -->
                <!-- 3️⃣ RISK FACTORS SECTION -->
                <!-- ═══════════════════════════════════════════════════════════════════ -->
                <div class="risk-section">
                    <div class="section-title">
                        <i class="fa-solid fa-triangle-exclamation"></i>
                        סיכונים שכדאי לדעת
                    </div>

                    <div class="risk-level" style="border-color: ${riskColor};">
                        <div class="risk-indicator" style="background: ${riskColor};"></div>
                        <div class="risk-content">
                            <div class="risk-title">רמת סיכון: <span style="color: ${riskColor};">${riskText}</span></div>
                            <div class="risk-subtitle">
                                ${conf > 75 ? 'תחזית יציבה עם ביטחון גבוה' : conf > 60 ? 'תחזית סבירה אך עם אי-ודאות מסוימת' : 'משחק בלתי צפוי - יש לנהוג בזהירות'}
                            </div>
                        </div>
                    </div>

                    <div class="risk-factors">
                        <div class="risk-factor">
                            <div class="risk-factor-icon">📊</div>
                            <div class="risk-factor-text">
                                <strong>דיוק היסטורי:</strong> TITAN השיג 73% הצלחה במשחקים דומים
                            </div>
                        </div>
                        ${conf < 70 ? `
                        <div class="risk-factor warning">
                            <div class="risk-factor-icon">⚠️</div>
                            <div class="risk-factor-text">
                                <strong>אזהרה:</strong> ביטחון נמוך מ-70% - מומלץ להיזהר בהימורים
                            </div>
                        </div>
                        ` : ''}
                        ${Math.abs(homeGoals - awayGoals) <= 1 ? `
                        <div class="risk-factor">
                            <div class="risk-factor-icon">⚖️</div>
                            <div class="risk-factor-text">
                                <strong>משחק צמוד:</strong> פער קטן בתוצאה - כל שער יכול להפוך את המשחק
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>

                <!-- ═══════════════════════════════════════════════════════════════════ -->
                <!-- 4️⃣ SECONDARY PREDICTIONS SECTION -->
                <!-- ═══════════════════════════════════════════════════════════════════ -->
                <div class="secondary-section">
                    <div class="section-title">
                        <i class="fa-solid fa-chart-line"></i>
                        תחזיות משניות
                    </div>

                    <div class="secondary-grid">
                        <div class="secondary-card">
                            <div class="secondary-icon">⚽</div>
                            <div class="secondary-content">
                                <div class="secondary-title">מספר שערים</div>
                                <div class="secondary-prediction">${goalsTypeHeb}-${goalsLine}</div>
                                <div class="secondary-confidence">
                                    ${goalsData.reason || 'מבוסס על ממוצעי שערים של הקבוצות'}
                                </div>
                            </div>
                        </div>

                        <div class="secondary-card">
                            <div class="secondary-icon">🎯</div>
                            <div class="secondary-content">
                                <div class="secondary-title">שתי הקבוצות יבקיעו?</div>
                                <div class="secondary-prediction">${bttsHeb}</div>
                                <div class="secondary-confidence">
                                    ${bttsReasonHeb}
                                </div>
                            </div>
                        </div>

                        <div class="secondary-card">
                            <div class="secondary-icon">📝</div>
                            <div class="secondary-content">
                                <div class="secondary-title">תרחיש צפוי</div>
                                <div class="secondary-prediction">
                                    ${homeGoals > awayGoals ? 'ניצחון ברור לבית' : awayGoals > homeGoals ? 'ניצחון חוץ מפתיע' : 'משחק צמוד ומאוזן'}
                                </div>
                                <div class="secondary-confidence">
                                    התוצאה ${scoreDisplay} משקפת משחק ${Math.abs(homeGoals - awayGoals) > 1 ? 'חד-צדדי' : 'מאוזן'}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Footer -->
                <div class="card-footer-v2">
                    <button class="action-btn-v2 primary" onclick="askTitanAboutMatch('${escapeHtml(p.home)}', '${escapeHtml(p.away)}')" title="שאל שאלות נוספות">
                        <i class="fa-solid fa-comments"></i>
                        שאל את TITAN
                    </button>
                    <button class="action-btn-v2" onclick='openJsonModal(JSON.parse("${safePayload}".replace(/&quot;/g, String.fromCharCode(34))))' title="הצג נתונים מלאים">
                        <i class="fa-solid fa-code"></i>
                        נתונים
                    </button>
                    <button class="action-btn-v2" onclick="refreshPrediction(${idx})" title="רענן תחזית">
                        <i class="fa-solid fa-rotate-right"></i>
                        רענן
                    </button>
                    <button class="action-btn-v2" onclick="savePrediction(${idx})" title="שמור">
                        <i class="fa-solid fa-bookmark"></i>
                        שמור
                    </button>
                </div>
            </div>
        `;
    }

    //
    // RENDER AUTO-FIX WARNING – הצגת אזהרת תיקון אוטומטי (מוסתר - רק ללוג)
    //
    function renderAutoFixWarning(p) {
        // הסרנו את ההצגה למשתמש - זה debug info בלבד
        return '';

        // קבל את הטקסט (תמיכה בגם string וגם object)
        const displayText = typeof autoFixRec === 'string'
            ? autoFixRec.replace(' ', '')
            : (autoFixRec.text || '').replace(' ', '');

        return `
            <div class="auto-fix-warning">
                <div class="auto-fix-icon"></div>
                <div class="auto-fix-text">
                    <strong>תיקון אוטומטי בוצע</strong><br>
                    ${escapeHtml(displayText)}
                </div>
            </div>
        `;
    }

    // 
    // RENDER DETAILED ANALYSIS – הצגת ניתוח מפורט
    // 
    function renderDetailedAnalysis(p) {
        const detailed = p.raw?.detailed_analysis || p.detailed_analysis;
        if (!detailed) return '';

        const confidenceReason = detailed.confidence_reasoning || 'רמת הביטחון מבוססת על ניתוח מקיף של הנתונים';
        const probBreakdown = detailed.probability_breakdown || {};
        const keyFactors = detailed.key_factors_explanation || [];
        const altScenarios = detailed.alternative_scenarios || '';

        let keyFactorsHTML = '';
        if (keyFactors.length > 0) {
            keyFactorsHTML = '<ul class="key-factors-list">';
            keyFactors.forEach(factor => {
                keyFactorsHTML += `<li>${escapeHtml(factor)}</li>`;
            });
            keyFactorsHTML += '</ul>';
        }

        let altScenariosHTML = '';
        if (altScenarios) {
            altScenariosHTML = `
                <div class="alternative-scenarios">
                    <div class="alternative-scenarios-title"> תרחישים אלטרנטיביים</div>
                    <div>${escapeHtml(altScenarios)}</div>
                </div>
            `;
        }

        let probReasonHTML = '';
        if (probBreakdown.reasoning) {
            probReasonHTML = `<div style="font-size: 11px; color: var(--text-muted); margin-top: 8px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 6px;">${escapeHtml(probBreakdown.reasoning)}</div>`;
        }

        return `
            <div class="detailed-analysis-section">
                <div class="detailed-analysis-header">
                    <div class="detailed-analysis-icon"></div>
                    <div class="detailed-analysis-title">ניתוח מעמיק</div>
                </div>
                <div class="confidence-reasoning">
                    <strong style="color: var(--success);">הסבר רמת ביטחון:</strong><br>
                    ${escapeHtml(confidenceReason)}
                </div>
                ${probReasonHTML}
                ${keyFactorsHTML}
                ${altScenariosHTML}
            </div>
        `;
    }

    // 
    // RENDER ALGORITHMIC TRANSPARENCY – הצגת שקיפות אלגוריתמית
    // 
    //
    // RENDER MVP MARKETS – תצוגת שווקים משלימים (קרנות, כרטיסים, שערים)
    //
    function renderMvpMarkets(p) {
        // נסה קודם מ-CTO format (markets), אחר כך מ-MVP format
        const ctoMarkets = p.raw?.markets || {};
        const mvpMarkets = p.raw?.mvp_markets || p.mvp_markets || {};

        // אם אין שום מידע - אל תציג כלום
        if (Object.keys(ctoMarkets).length === 0 && Object.keys(mvpMarkets).length === 0) {
            return '';
        }

        const markets = [];

        // CTO Format - שערים (goals)
        if (ctoMarkets.goals) {
            const g = ctoMarkets.goals;
            markets.push(`
                <div class="mvp-market-item">
                    <div class="mvp-market-icon">⚽</div>
                    <div class="mvp-market-content">
                        <div class="mvp-market-type">שערים</div>
                        <div class="mvp-market-prediction">${escapeHtml(g.type)} ${g.line}</div>
                        <div class="mvp-market-reason">${escapeHtml(g.reason || '')}</div>
                    </div>
                </div>
            `);
        }

        // CTO Format - קרנות (corners)
        if (ctoMarkets.corners) {
            const c = ctoMarkets.corners;
            markets.push(`
                <div class="mvp-market-item">
                    <div class="mvp-market-icon">🚩</div>
                    <div class="mvp-market-content">
                        <div class="mvp-market-type">קרנות</div>
                        <div class="mvp-market-prediction">${escapeHtml(c.expected_range)}</div>
                        <div class="mvp-market-reason">${escapeHtml(c.reason || '')}</div>
                    </div>
                </div>
            `);
        }

        // CTO Format - כרטיסים צהובים (yellow_cards)
        if (ctoMarkets.yellow_cards) {
            const y = ctoMarkets.yellow_cards;
            markets.push(`
                <div class="mvp-market-item">
                    <div class="mvp-market-icon">🟨</div>
                    <div class="mvp-market-content">
                        <div class="mvp-market-type">כרטיסים צהובים</div>
                        <div class="mvp-market-prediction">${escapeHtml(y.expected_range)}</div>
                        <div class="mvp-market-reason">${escapeHtml(y.reason || '')}</div>
                    </div>
                </div>
            `);
        }

        // CTO Format - כרטיס אדום (red_card)
        if (ctoMarkets.red_card) {
            const r = ctoMarkets.red_card;
            const probHeb = r.probability === 'low' ? 'סיכוי נמוך' : r.probability === 'medium' ? 'סיכוי בינוני' : 'סיכוי גבוה';
            markets.push(`
                <div class="mvp-market-item">
                    <div class="mvp-market-icon">🟥</div>
                    <div class="mvp-market-content">
                        <div class="mvp-market-type">כרטיס אדום</div>
                        <div class="mvp-market-prediction">${probHeb}</div>
                        <div class="mvp-market-reason">${escapeHtml(r.reason || '')}</div>
                    </div>
                </div>
            `);
        }

        // MVP Format - 1X2 (fallback)
        if (mvpMarkets['1x2'] && markets.length === 0) {
            const m = mvpMarkets['1x2'];
            markets.push(`
                <div class="mvp-market-item">
                    <div class="mvp-market-icon">📊</div>
                    <div class="mvp-market-content">
                        <div class="mvp-market-type">${escapeHtml(m.type || '1X2')}</div>
                        <div class="mvp-market-prediction">${escapeHtml(m.prediction || 'N/A')}</div>
                        <div class="mvp-market-confidence">ביטחון: ${m.confidence || 0}%</div>
                    </div>
                </div>
            `);
        }

        // MVP Format - Over/Under (fallback)
        if (mvpMarkets.over_under && markets.length < 4) {
            const m = mvpMarkets.over_under;
            markets.push(`
                <div class="mvp-market-item">
                    <div class="mvp-market-icon">📈</div>
                    <div class="mvp-market-content">
                        <div class="mvp-market-type">${escapeHtml(m.type || 'Over/Under')}</div>
                        <div class="mvp-market-prediction">${escapeHtml(m.prediction || 'N/A')}</div>
                        <div class="mvp-market-confidence">ביטחון: ${m.confidence || 0}%</div>
                    </div>
                </div>
            `);
        }

        if (markets.length === 0) return '';

        return `
            <div class="mvp-markets-section" style="margin-top: 14px; padding: 12px; background: rgba(16, 185, 129, 0.05); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: var(--radius-md);">
                <div class="mvp-markets-header" style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; font-weight: 700; color: var(--success);">
                    <i class="fa-solid fa-chart-line"></i>
                    <span>שווקים משלימים</span>
                </div>
                <div class="mvp-markets-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                    ${markets.join('')}
                </div>
            </div>
        `;
    }

    //
    // RENDER TITAN SUMMARY – סיכום TITAN
    //
    function renderTitanSummary(p) {
        // חפש את הסיכום במקומות שונים
        const summary = p.raw?.summary || p.summary || {};
        const verdict = summary.titan_verdict || p.raw?.titan_verdict || '';

        // אם אין סיכום - אל תציג
        if (!verdict || verdict === 'לא זמין' || verdict.trim() === '') {
            return '';
        }

        return `
            <div class="titan-summary-section" style="margin-top: 14px; padding: 14px; background: linear-gradient(135deg, rgba(96,165,250,0.1), rgba(139,92,246,0.08)); border: 1px solid rgba(96,165,250,0.3); border-radius: var(--radius-md);">
                <div class="titan-summary-header" style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-weight: 800; color: #a78bfa; font-size: 14px;">
                    <i class="fa-solid fa-brain"></i>
                    <span>סיכום TITAN</span>
                </div>
                <div class="titan-summary-text" style="font-size: 13px; line-height: 1.8; color: var(--text); padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; border-right: 3px solid var(--primary);">
                    ${escapeHtml(verdict)}
                </div>
            </div>
        `;
    }

    function renderAlgorithmicTransparency(p) {
        const algo = p.raw?.algorithmic_transparency || p.algorithmic_transparency;
        if (!algo) return '';

        const weights = algo.model_weights || {};
        const dataQuality = algo.data_quality || 'medium';
        const certainty = algo.prediction_certainty || '';
        const limitations = algo.limitations || '';

        let weightsHTML = '';
        if (Object.keys(weights).length > 0) {
            weightsHTML = '<div class="model-weights">';
            Object.entries(weights).forEach(([key, value]) => {
                const label = key.replace(/_/g, ' ').toUpperCase();
                weightsHTML += `
                    <div class="weight-item">
                        <div class="weight-label">${label}</div>
                        <div class="weight-value">${value}%</div>
                        <div class="weight-bar" style="--weight: ${value}%"></div>
                    </div>
                `;
            });
            weightsHTML += '</div>';
        }

        const qualityClass = dataQuality === 'high' ? '' : (dataQuality === 'low' ? 'low' : 'medium');
        const qualityText = dataQuality === 'high' ? 'גבוהה' : (dataQuality === 'low' ? 'נמוכה' : 'בינונית');

        return `
            <div class="algo-transparency-section">
                <div class="algo-header">
                    <div class="algo-icon"></div>
                    <div class="algo-title">שקיפות אלגוריתמית</div>
                </div>
                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 12px;">
                    המשקלות שהמודל נתן לכל פקטור בחישוב התחזית:
                </div>
                ${weightsHTML}
                <div>
                    <span class="data-quality-badge ${qualityClass}">
                        איכות נתונים: ${qualityText}
                    </span>
                </div>
                ${certainty ? `<div class="prediction-certainty"><strong>רמת ודאות:</strong><br>${escapeHtml(certainty)}</div>` : ''}
                ${limitations ? `<div class="limitations-note"><strong> הגבלות:</strong><br>${escapeHtml(limitations)}</div>` : ''}
            </div>
        `;
    }

    // 
    // RENDER EXPLAINABILITY – TITAN v2.0
    // 
    function renderExplainability(p) {
        const explainability = p.extended_stats?.explainability || p.explainability;

        if (!explainability || !explainability.drivers || explainability.drivers.length === 0) {
            return '';
        }

        const xgHome = p.factors?.xg_home || 0;
        const xgAway = p.factors?.xg_away || 0;
        const xgTotal = p.factors?.total_xg || 0;
        const netImpact = explainability.net_impact || 0;

        // Build drivers HTML with icons
        let driversHTML = '';
        const driverIcons = {
            'high_total_xg': '',
            'btts_tendency': '',
            'home_advantage': '',
            'high_tempo': '',
            'excellent_form': '',
            'derby_match': '',
            'high_home_xg': '',
            'high_away_xg': ''
        };

        explainability.drivers.forEach(driver => {
            const factor = driver.factor || '';
            const icon = driverIcons[factor] || '';
            driversHTML += `
                <div class="explainability-driver">
                    <span class="driver-icon">${icon}</span>
                    <span class="driver-text">${escapeHtml(driver.explanation || driver.factor)}</span>
                    <span class="driver-impact">${driver.impact}</span>
                </div>
            `;
        });

        // Build reducers HTML if any
        let reducersHTML = '';
        if (explainability.reducers && explainability.reducers.length > 0) {
            reducersHTML = '<div class="explainability-reducers-title"> גורמים מפחיתים</div>';
            explainability.reducers.forEach(reducer => {
                reducersHTML += `
                    <div class="explainability-reducer">
                        <span class="reducer-text">${escapeHtml(reducer.explanation || reducer.factor)}</span>
                        <span class="reducer-impact">${reducer.impact}</span>
                    </div>
                `;
            });
        }

        // Net impact styling
        let impactColor = '#f59e0b';
        let impactText = ' טוב';
        if (netImpact > 0.5) {
            impactColor = '#10b981';
            impactText = ' חזק מאוד!';
        } else if (netImpact > 0.3) {
            impactColor = '#8BC34A';
            impactText = ' חזק!';
        } else if (netImpact < 0) {
            impactColor = '#ef4444';
            impactText = ' חלש';
        }

        return `
            <div class="explainability-card">
                <div class="explainability-header">
                    <h4> למה התחזית הזו?</h4>
                    <span class="explainability-badge">TITAN v2.0</span>
                </div>

                <div class="explainability-drivers">
                    <div class="explainability-drivers-title"> גורמים חיוביים</div>
                    ${driversHTML}
                </div>

                ${xgTotal > 0 ? `
                <div class="explainability-xg">
                    <h5> Expected Goals (XG)</h5>
                    <div class="xg-row">
                        <span class="xg-team">${escapeHtml(p.home?.substring(0, 15) || 'בית')}</span>
                        <div class="xg-bar-container">
                            <div class="xg-bar-home" style="width: ${(xgHome / xgTotal * 100).toFixed(0)}%"></div>
                        </div>
                        <span class="xg-value">${xgHome.toFixed(2)}</span>
                    </div>
                    <div class="xg-row">
                        <span class="xg-team">${escapeHtml(p.away?.substring(0, 15) || 'אורח')}</span>
                        <div class="xg-bar-container">
                            <div class="xg-bar-away" style="width: ${(xgAway / xgTotal * 100).toFixed(0)}%"></div>
                        </div>
                        <span class="xg-value">${xgAway.toFixed(2)}</span>
                    </div>
                    <div class="xg-total">סה"כ XG: <strong>${xgTotal.toFixed(2)}</strong></div>
                </div>
                ` : ''}

                ${reducersHTML}

                <div class="explainability-impact">
                    <span class="impact-label">Net Impact:</span>
                    <span class="impact-value" style="color: ${impactColor}">
                        ${netImpact >= 0 ? '+' : ''}${netImpact.toFixed(2)}
                    </span>
                    <span class="impact-indicator">${impactText}</span>
                </div>
            </div>
        `;
    }

    // 
    // RENDER DISCLAIMER – v9.1 Blueprint Compliant
    // 
    function renderDisclaimer(p) {
        // v9.1: Disclaimer is always present and mandatory
        const disclaimerText = p.raw?.disclaimer || p.disclaimer || 'המידע מוצג לצורכי מחקר וידע בלבד. אין בו המלצה להימור או החלטה פיננסית. השימוש באתר מהווה הסכמה לתנאי השימוש.';

        return `
            <div class="v91-disclaimer">
                <div class="v91-disclaimer-icon"></div>
                <div class="v91-disclaimer-content">
                    <div class="v91-disclaimer-title">אזהרה חשובה</div>
                    <div class="v91-disclaimer-text">${escapeHtml(disclaimerText)}</div>
                </div>
            </div>
        `;
    }

    // 
    // GENERATE SMART INSIGHT – יצירת ניתוח AI חכם
    // תוקן: standard = 50-100 תווים, deep = 200-250 תווים
    // 
    function generateSmartInsight(p, depth = 'standard') {
        const home = p.home || 'הקבוצה הביתית';
        const away = p.away || 'הקבוצה האורחת';
        const conf = p.confidence || 70;
        const factors = p.factors || {};

        const homeAdv = factors.home_advantage || 70;
        const form = factors.form || 65;
        const attack = factors.attack || 70;
        const defense = factors.defense || 65;

        // 
        // STANDARD MODE – קצר ותכליתי (50-100 תווים)
        // 
        if (depth === 'standard') {
            if (conf > 75) {
                return `<strong>${home}</strong> עם יתרון ברור (${conf}% ביטחון). פורמה ${form}%, התקפה ${attack}%.`;
            } else if (conf > 60) {
                return `משחק מאוזן עם יתרון קל ל<strong>${home}</strong>. יתרון בית ${homeAdv}%.`;
            } else {
                return `משחק פתוח – תוצאה לא צפויה. מומלץ לשקול תיקו או להימנע.`;
            }
        }

        // 
        // DEEP MODE – ניתוח מעמיק (200-250 תווים, 3-5 נקודות)
        // 
        const insights = [];

        // נקודה 1: יתרון בית
        if (homeAdv > 70) {
            insights.push(` <strong>יתרון ביתי משמעותי:</strong> ${home} נהנית מיתרון של ${homeAdv}% במגרש הביתי – גורם קריטי בהכרעה.`);
        } else {
            insights.push(` <strong>יתרון ביתי:</strong> ${home} עם יתרון בית סטנדרטי (${homeAdv}%).`);
        }

        // נקודה 2: פורמה
        if (form > 75) {
            insights.push(` <strong>פורמה מעולה:</strong> מומנטום חיובי (${form}%) – הקבוצה בשיא הביצועים.`);
        } else if (form > 60) {
            insights.push(` <strong>פורמה:</strong> ביצועים סבירים (${form}%) – יציבות טקטית.`);
        } else {
            insights.push(` <strong>פורמה ירודה:</strong> רק ${form}% – סימן אזהרה משמעותי.`);
        }

        // נקודה 3: התקפה
        if (attack > 75) {
            insights.push(` <strong>כושר התקפי גבוה:</strong> ${attack}% – יכולת הבקעה מרשימה.`);
        } else {
            insights.push(` <strong>התקפה:</strong> ${attack}% – ממוצע ליגתי.`);
        }

        // נקודה 4: הגנה
        if (defense > 70) {
            insights.push(` <strong>הגנה מוצקה:</strong> ${defense}% – קשה לחדור.`);
        }

        // נקודה 5: סיכום + המלצת טוטו
        let totoRec = '1';
        if (conf < 55) {
            totoRec = 'X';
        } else if (homeAdv < 50) {
            totoRec = '2';
        }
        insights.push(` <strong>המלצת טוטו:</strong> סימון <span style="color: var(--gold); font-weight: 800;">${totoRec}</span> (ביטחון ${conf}%).`);

        return insights.join('<br><br>');
    }

    // 
    // REMOVE CARD – מחיקת כרטיס תחזית (כפתור X)
    // 
    function removeCard(idx) {
        if (idx >= 0 && idx < predictions.length) {
            const removed = predictions.splice(idx, 1)[0];
            termLog(`נמחק: ${removed.home} vs ${removed.away}`, 'warning');
            displayResults([]);  // רענון התצוגה
            showToast('info', 'נמחק', 'הכרטיס הוסר מהתצוגה');
        }
    }

    // 
    // UTILITIES – פונקציות עזר
    // 
    function swapTeams(mode) {
        if (mode === 'custom') {
            const h = document.getElementById('customHomeSelect');
            const a = document.getElementById('customAwaySelect');
            [h.value, a.value] = [a.value, h.value];
        }
        showToast('info', 'הוחלף', 'הקבוצות הוחלפו');
    }

    function clearCustom() {
        document.getElementById('customHomeSelect').value = '';
        document.getElementById('customAwaySelect').value = '';
        showToast('info', 'נוקה', 'השדות נוקו');
    }

    async function refreshPrediction(idx) {
        const p = predictions[idx];
        if (!p) return;

        termLog(`מרענן תחזית עבור: ${p.home} vs ${p.away}`, 'ai');
        showLoading(true);

        try {
            const updated = await fetchPrediction(p.home, p.away, p.league, null, analysisDepth);
            if (updated) {
                predictions[idx] = updated;
                displayResults([]);
                showToast('success', 'רועננה', 'התחזית עודכנה מחדש');
            }
        } catch (e) {
            showToast('error', 'שגיאה', 'לא ניתן לרענן את התחזית כרגע');
        } finally {
            showLoading(false);
        }
    }

    // 
    // SAVE PREDICTION – שמירת תחזית לפרופיל המשתמש
    // תוקן: קישור לדף profile.html
    // 
    //
    // ASK TITAN ABOUT MATCH – שאל את TITAN על משחק ספציפי
    //
    async function askTitanAboutMatch(homeTeam, awayTeam) {
        try {
            termLog(`🤖 פותח צ'אט TITAN עבור: ${homeTeam} vs ${awayTeam}`, 'ai');

            // פתיחת AI Popup
            openAiPopup();

            // טעינת סטטיסטיקות של שתי הקבוצות
            termLog(`📊 טוען סטטיסטיקות לשתי הקבוצות...`, 'ai');

            const [homeStats, awayStats] = await Promise.all([
                getTeamStatistics(homeTeam),
                getTeamStatistics(awayTeam)
            ]);

            // בניית שאלה מפורטת עם סטטיסטיקות
            let question = `נתח לי את המשחק בין ${homeTeam} ל-${awayTeam}`;

            // הוספת context אם יש סטטיסטיקות
            if (homeStats && awayStats) {
                const homeWin = homeStats.statistics.win_percentage;
                const awayWin = awayStats.statistics.win_percentage;
                const homeForm = homeStats.statistics.current_form;
                const awayForm = awayStats.statistics.current_form;

                question += `\n\nסטטיסטיקות:\n`;
                question += `${homeTeam}: ${homeWin}% ניצחונות, כושר ${homeForm}\n`;
                question += `${awayTeam}: ${awayWin}% ניצחונות, כושר ${awayForm}`;

                // שמירת הסטטיסטיקות למשתנה גלובלי לשימוש ב-sendChatMessage
                window._titanContext = {
                    homeTeam: homeTeam,
                    awayTeam: awayTeam,
                    homeStats: homeStats,
                    awayStats: awayStats
                };

                termLog(`✅ סטטיסטיקות נטענו והועברו ל-TITAN`, 'success');
            } else {
                termLog(`⚠️ לא נמצאו סטטיסטיקות, מנתח ללא נתונים`, 'warning');
                window._titanContext = null;
            }

            // מילוי תיבת הטקסט
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.value = question;
            }

            // שליחה אוטומטית לTITAN
            setTimeout(() => {
                sendChatMessage();
            }, 500);

        } catch (error) {
            console.error('Error opening TITAN chat:', error);
            showToast('error', 'שגיאה', 'לא ניתן לפתוח צ\'אט עם TITAN');
        }
    }

    async function savePrediction(idx) {
        const p = predictions[idx];
        if (!p) return;

        // בדיקת טוקן – מחפש בכל המקומות האפשריים
        const token = localStorage.getItem('token') ||
                      localStorage.getItem('authToken') ||
                      localStorage.getItem('access_token');

        if (!token) {
            showToast('warning', 'נדרש להתחבר', 'כדי לשמור תחזיות עליך להתחבר למערכת');
            termLog('שמירת תחזית נכשלה – אין טוקן התחברות', 'warning');
            // הפניה לדף התחברות אחרי 2 שניות
            setTimeout(() => {
                if (confirm('האם לעבור לדף ההתחברות?')) {
                    window.location.href = 'login.html';
                }
            }, 1000);
            return;
        }

        const body = {
            home: p.home,
            away: p.away,
            league: p.league || 'לא צוין',
            score: p.prediction?.score || '',
            confidence: p.prediction?.confidence || p.confidence || 0,
            notes: `engine=${p.aiMode || 'UNKNOWN'}; depth=${p.depth || analysisDepth}`
        };

        termLog(`שומר תחזית: ${p.home} vs ${p.away}`, 'ai');

        try {
            const res = await fetch(`${API_BASE}/api/predictions/save`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(body)
            });

            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.detail || `HTTP ${res.status}`);
            }

            const data = await res.json();
            showToast('success', 'נשמר!', 'התחזית נשמרה – צפה בה בדף הפרופיל');
            termLog('תחזית נשמרה בהצלחה בפרופיל המשתמש', 'success');

            // הצעה לעבור לפרופיל
            setTimeout(() => {
                if (confirm('התחזית נשמרה! האם לעבור לדף הפרופיל לצפייה?')) {
                    window.location.href = 'profile.html';
                }
            }, 1500);

        } catch (e) {
            showToast('error', 'שגיאה בשמירה', e.message);
            termLog(`שגיאה בשמירת תחזית: ${e.message}`, 'error');
        }
    }

    function setView(mode) {
        const grid = document.getElementById('resultsGrid');
        grid.classList.toggle('list-view', mode === 'list');
        document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
        event.target.closest('.view-btn').classList.add('active');
    }

    // 
    // CHECK AI STATUS – בדיקת סטטוס AI
    // 
    async function checkAIStatus() {
        try {
            termLog(`🔍 בודק סטטוס AI ב-${API_BASE}/api/ai/status`, 'ai');
            const res = await fetch(`${API_BASE}/api/ai/status`);

            termLog(`📡 תגובת שרת: status=${res.status}`, res.ok ? 'success' : 'error');

            if (!res.ok) {
                throw new Error(`HTTP ${res.status}`);
            }

            const data = await res.json();
            termLog(`📊 נתוני AI: ${JSON.stringify(data)}`, 'ai');

            const isOnline = !!data.ai_online;
            const statusEl = document.getElementById('aiStatusText');
            if (statusEl) {
                statusEl.textContent = isOnline ? 'GPT-4o מחובר' : 'Fallback';
            }

            const bannerEl = document.getElementById('aiBannerStatus');
            if (bannerEl) {
                bannerEl.innerHTML = isOnline
                    ? '<div class="dot"></div>מחובר ל‑TITAN AI'
                    : '<div class="dot"></div>מצב Fallback (מנוע לוגי)';
            }

            termLog(isOnline ? '✅ TITAN AI מחובר (TITAN Online)' : '⚠️ מצב Fallback (ללא OpenAI)', isOnline ? 'success' : 'warning');
        } catch (e) {
            console.error('❌ שגיאה מפורטת ב-checkAIStatus:', e);
            const statusEl = document.getElementById('aiStatusText');
            if (statusEl) {
                statusEl.textContent = 'לא זמין';
            }

            const bannerEl = document.getElementById('aiBannerStatus');
            if (bannerEl) {
                bannerEl.innerHTML = '<div class="dot"></div>לא מחובר לשרת';
            }

            termLog(`❌ שגיאה בבדיקת סטטוס AI: ${e.message}`, 'error');
            termLog(`💡 ודא שהשרת רץ ב-${API_BASE}`, 'warning');
        }
    }

    // 
    // SHOW LOADING – הצגת מסך טעינה
    // 
    function showLoading(show) {
        const overlay = document.getElementById('loadingOverlay');
        const bar = document.getElementById('progressBar');
        if (show) {
            overlay.classList.add('active');
            let p = 0;
            const int = setInterval(() => {
                p += 5;
                bar.style.width = Math.min(p, 95) + '%';
                if (p >= 100) clearInterval(int);
            }, 120);
        } else {
            overlay.classList.remove('active');
            bar.style.width = '0%';
        }
    }

    // 
    // SHOW TOAST – הצגת הודעת Toast
    // 
    function showToast(type, title, msg) {
        const c = document.getElementById('toastContainer');
        const icons = {
            success: 'fa-check',
            error: 'fa-times',
            warning: 'fa-exclamation',
            info: 'fa-info'
        };
        const t = document.createElement('div');
        t.className = `toast ${type}`;
        t.innerHTML = `
        <div class="toast-icon"><i class="fa-solid ${icons[type]}"></i></div>
        <div class="toast-content">
        <div class="toast-title">${title}</div>
        <div class="toast-message">${msg}</div>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">
        <i class="fa-solid fa-times"></i>
        </button>`;
        c.appendChild(t);
        setTimeout(() => t.remove(), 4000);
    }

    // 
    // TERM LOG – כתיבה לטרמינל
    // 
    function termLog(msg, type = 'text') {
        const t = document.getElementById('terminal');
        const cls = {
            success: 'terminal-success',
            error: 'terminal-error',
            warning: 'terminal-warning',
            ai: 'terminal-ai',
            text: 'terminal-text'
        };
        const line = document.createElement('div');
        line.className = 'terminal-line';
        line.innerHTML = `<span class="terminal-prompt">$</span><span class="${cls[type] || 'terminal-text'}">${msg}</span>`;
        t.appendChild(line);
        t.scrollTop = t.scrollHeight;
    }

    // 
    //  AI POPUP ULTIMATE FUNCTIONS – פונקציות חלון קופץ מתקדם
    // 

    // הודעות טעינה מצחיקות ומקצועיות
    const loadingMessages = [
        ' TITAN מנתח נתונים...',
        ' מעבד 10 מימדים...',
        ' קורא כוכבי שחקנים...',
        ' בודק פורמה אחרונה...',
        ' מחשב הסתברויות...',
        ' GPT-4o חושב עמוק...',
        ' כמעט שם...',
        ' התחזית מתבשלת...'
    ];

    let loadingInterval = null;

    function showPopupLoading(show = true) {
        const loader = document.getElementById('aiPopupLoading');
        const loadingText = document.getElementById('aiLoadingText');

        if (show) {
            loader.classList.add('active');
            let msgIndex = 0;
            loadingText.textContent = loadingMessages[msgIndex];

            // שינוי הודעת טעינה כל 1.5 שניות
            loadingInterval = setInterval(() => {
                msgIndex = (msgIndex + 1) % loadingMessages.length;
                loadingText.textContent = loadingMessages[msgIndex];
            }, 1500);
        } else {
            loader.classList.remove('active');
            if (loadingInterval) {
                clearInterval(loadingInterval);
                loadingInterval = null;
            }
        }
    }

    async function getAiPopupPrediction() {
        const resultDiv = document.getElementById('aiPopupResult');
        resultDiv.style.display = 'none';

        // בוחר משחק רנדומלי מהמילון
        const leagues = dictionary?.leagues || {};
        const allTeams = [];

        Object.values(leagues).forEach(league => {
            (league.competitions || []).forEach(comp => {
                (comp.teams || []).forEach(team => {
                    allTeams.push({
                        name: typeof team === 'string' ? team : team.name,
                        league: comp.englishName || comp.name,
                        country: league.name || ''
                    });
                });
            });
        });

        if (allTeams.length < 2) {
            resultDiv.innerHTML = `
                <h3> אופס!</h3>
                <p>אין מספיק קבוצות במערכת. טען את המילון קודם!</p>
            `;
            resultDiv.style.display = 'block';
            return;
        }

        // בחירת 2 קבוצות רנדומליות שונות
        let home = allTeams[Math.floor(Math.random() * allTeams.length)];
        let away = allTeams[Math.floor(Math.random() * allTeams.length)];

        // ודא שהקבוצות שונות
        let attempts = 0;
        while (home.name === away.name && attempts < 10) {
            away = allTeams[Math.floor(Math.random() * allTeams.length)];
            attempts++;
        }

        termLog(` AI Popup Demo: ${home.name} vs ${away.name}`, 'ai');
        showPopupLoading(true);

        try {
            const pred = await fetchPrediction(home.name, away.name, home.league || 'General', null, 'standard');
            showPopupLoading(false);

            if (pred && pred.prediction) {
                const rawScore = pred.prediction.score || '0-0';
                const parts = rawScore.split('-').map(s => parseInt(s.trim(), 10));

                let homeGoals = 0, awayGoals = 0;
                if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                    homeGoals = parts[0];
                    awayGoals = parts[1];
                }

                const score = `${homeGoals}-${awayGoals}`;
                const conf = pred.confidence || 70;

                // קביעת מנצחת
                let winner = 'תיקו';
                let winnerIcon = '';
                if (homeGoals > awayGoals) {
                    winner = home.name;
                    winnerIcon = '';
                } else if (awayGoals > homeGoals) {
                    winner = away.name;
                    winnerIcon = '';
                }

                // הודעה מקצועית
                const randomFunny = `<strong>ניתוח מקצועי בוצע</strong><br>
                     ביטחון: ${conf}%<br>
                     ניתוח 10-מימדי: פורמה, H2H, מומנטום, xG ועוד`;

                resultDiv.innerHTML = `
                    <h3>ניתוח התחזית</h3>

                    <div class="match-display">
                        <div style="font-size: 16px; color: var(--text-muted); margin-bottom: 8px;">
                            ${home.league}${home.country ? ` • ${home.country}` : ''}
                        </div>
                        <div style="display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap;">
                            <span style="color: ${homeGoals > awayGoals ? 'var(--gold)' : 'var(--text)'};">
                                ${home.name}
                            </span>
                            <span style="color: var(--text-dim);">VS</span>
                            <span style="color: ${awayGoals > homeGoals ? 'var(--gold)' : 'var(--text)'};">
                                ${away.name}
                            </span>
                        </div>
                    </div>

                    <div class="score-display">${score}</div>

                    <p style="font-size: 20px; margin: 15px 0;">
                        ${winnerIcon} <strong style="color: var(--gold);">מנצחת:</strong> ${winner}
                    </p>

                    <div style="display: flex; justify-content: center; gap: 20px; margin: 15px 0; font-size: 14px;">
                        <div>
                            <div style="color: var(--text-muted);">ביטחון AI</div>
                            <div style="font-size: 24px; font-weight: 800; color: ${conf > 75 ? 'var(--success)' : conf > 60 ? 'var(--warning)' : 'var(--danger)'};">
                                ${conf}%
                            </div>
                        </div>
                        <div>
                            <div style="color: var(--text-muted);">Engine</div>
                            <div style="font-size: 14px; font-weight: 700; color: var(--primary); margin-top: 5px;">
                                 ${pred.aiMode || 'TITAN'}
                            </div>
                        </div>
                    </div>

                    <div class="funny-note">
                        ${randomFunny}
                    </div>

                    <div style="margin-top: 20px; padding: 15px; background: rgba(139,92,246,0.1); border-radius: 12px; border: 1px solid rgba(139,92,246,0.3);">
                        <div style="font-size: 13px; color: var(--text-muted); line-height: 1.7;">
                             <strong>רוצה יותר?</strong> זה רק קצה הקרחון!<br>
                            גלה את מלוא היכולות בממשק התחזיות המלא 
                        </div>
                    </div>
                `;

                resultDiv.style.display = 'block';

                // אפקט קונפטי מרשים!
                confetti({
                    particleCount: 150,
                    spread: 90,
                    origin: { y: 0.6 },
                    colors: ['#10b981', '#3b82f6', '#8b5cf6', '#fbbf24']
                });

                termLog(` תחזית הושלמה: ${score} | ביטחון: ${conf}%`, 'success');
            }
        } catch (err) {
            showPopupLoading(false);
            resultDiv.innerHTML = `
                <h3> אופס!</h3>
                <p style="font-size: 16px; margin: 15px 0;">
                    נתקלנו בתקלה קטנה. אל תדאג – זה לא האיכות שלנו! 
                </p>
                <p style="font-size: 14px; color: var(--text-muted);">
                    בדרך כלל TITAN עובד מושלם. נסה שוב או חקור את האתר!
                </p>
            `;
            resultDiv.style.display = 'block';
            termLog(` AI Popup Error: ${err.message}`, 'error');
        }
    }

    // ═══════════════════════════════════════════════════════════
    // 🔐 User Authentication UI Management
    // ═══════════════════════════════════════════════════════════

    /**
     * בדיקה אם משתמש מחובר
     */
    function isUserLoggedIn() {
        const token = localStorage.getItem('access_token');
        if (!token) return false;

        try {
            const parts = token.split('.');
            if (parts.length !== 3) return false;

            const payload = JSON.parse(atob(parts[1]));
            const now = Math.floor(Date.now() / 1000);

            if (payload.exp && payload.exp < now) {
                localStorage.removeItem('access_token');
                localStorage.removeItem('user');
                return false;
            }

            return true;
        } catch (e) {
            console.error('Token validation error:', e);
            return false;
        }
    }

    /**
     * קבלת פרטי המשתמש המחובר
     */
    function getCurrentUser() {
        try {
            const userStr = localStorage.getItem('user');
            return userStr ? JSON.parse(userStr) : null;
        } catch (e) {
            return null;
        }
    }

    /**
     * עדכון תצוגת כפתורי ההתחברות/פרופיל
     */
    function updateAuthUI() {
        const loginBtn = document.getElementById('loginBtn');
        const profileBtn = document.getElementById('profileBtn');
        const logoutBtn = document.getElementById('logoutBtn');

        if (isUserLoggedIn()) {
            if (loginBtn) loginBtn.style.display = 'none';
            if (profileBtn) profileBtn.style.display = 'flex';
            if (logoutBtn) logoutBtn.style.display = 'flex';

            const user = getCurrentUser();
            if (user && profileBtn) {
                const nameSpan = profileBtn.querySelector('span');
                if (nameSpan) {
                    nameSpan.textContent = user.name || 'הפרופיל שלי';
                }
            }
        } else {
            if (loginBtn) loginBtn.style.display = 'flex';
            if (profileBtn) profileBtn.style.display = 'none';
            if (logoutBtn) logoutBtn.style.display = 'none';
        }
    }

    /**
     * התנתקות משתמש
     */
    function logout() {
        localStorage.removeItem('access_token');
        localStorage.removeItem('user');
        showToast('success', 'התנתקות', 'התנתקת בהצלחה! 👋');
        updateAuthUI();
        return false;
    }

    // עדכון UI בטעינת הדף
    document.addEventListener('DOMContentLoaded', function() {
        updateAuthUI();
        setInterval(updateAuthUI, 30000);
    });

    // ═══════════════════════════════════════════════════════════
    // GO TO AI ANALYZER - Navigate to AI Match Analyzer with form data
    // ═══════════════════════════════════════════════════════════
    function goToAIAnalyzer(mode) {
        let homeTeam, awayTeam, leagueId;

        if (mode === 'league') {
            const leagueCompositeKey = document.getElementById('leagueSelect').value;
            homeTeam = document.getElementById('homeTeamSelect').value;
            awayTeam = document.getElementById('awayTeamSelect').value;

            if (!leagueCompositeKey || !homeTeam || !awayTeam) {
                showToast('warning', 'שים לב', 'בחר ליגה ושתי קבוצות');
                return;
            }
            if (homeTeam === awayTeam) {
                showToast('warning', 'שים לב', 'הקבוצות חייבות להיות שונות');
                return;
            }

            // Extract league ID from composite key
            const meta = leagueIndex[leagueCompositeKey];
            leagueId = meta ? meta.leagueId : 39;

        } else if (mode === 'custom') {
            homeTeam = document.getElementById('customHomeSelect').value;
            awayTeam = document.getElementById('customAwaySelect').value;

            if (!homeTeam || !awayTeam) {
                showToast('warning', 'שים לב', 'בחר שתי קבוצות');
                return;
            }
            if (homeTeam === awayTeam) {
                showToast('warning', 'שים לב', 'הקבוצות חייבות להיות שונות');
                return;
            }

            // Default to Premier League for custom matches
            leagueId = 39;
        }

        // Save to sessionStorage and navigate
        sessionStorage.setItem('ai_match_data', JSON.stringify({
            league_id: leagueId,
            home_team: homeTeam,
            away_team: awayTeam,
            from_page: 'predictions'
        }));

        termLog(`🧠 נתב ל-AI Analyzer: ${homeTeam} vs ${awayTeam} (League ${leagueId})`, 'success');
        window.location.href = 'ai-match-analyzer.html';
    }

</script>

<!-- ═══════════════════════════════════════════════════════════
     FLOATING TITAN BUTTON
     כפתור צף לפתיחת TITAN AI מכל מקום בדף
═══════════════════════════════════════════════════════════ -->
<div class="floating-titan" onclick="openAiPopup()" title="שאל את TITAN AI">
    <i class="fas fa-robot"></i>
</div>

<style>
    /* Floating TITAN Button Styles */
    .floating-titan {
        position: fixed;
        bottom: 32px;
        left: 32px;
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, var(--primary), var(--accent));
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4);
        z-index: 9999;
        font-size: 28px;
        color: white;
        transition: all 0.3s ease;
        animation: float 3s ease-in-out infinite;
    }

    .floating-titan:hover {
        transform: scale(1.1) translateY(-2px);
        box-shadow: 0 12px 32px rgba(59, 130, 246, 0.6);
        background: linear-gradient(135deg, var(--accent), var(--primary));
    }

    .floating-titan:active {
        transform: scale(0.95);
    }

    /* Float animation for subtle movement */
    @keyframes float {
        0%, 100% {
            transform: translateY(0px);
        }
        50% {
            transform: translateY(-10px);
        }
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .floating-titan {
            bottom: 20px;
            left: 20px;
            width: 56px;
            height: 56px;
            font-size: 24px;
        }
    }

    /* Pulse effect when there's new content */
    .floating-titan.pulse {
        animation: float 3s ease-in-out infinite, pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
        0%, 100% {
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4);
        }
        50% {
            box-shadow: 0 8px 40px rgba(59, 130, 246, 0.8);
        }
    }
</style>

</body>
</html>
